<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBooking - ระบบจองใช้งานทรัพยากร</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Prompt', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; overflow-x: hidden; background-color: #f8fafc; }
        @keyframes scan-line {
            0% { top: 15%; }
            100% { top: 85%; }
        }
        .animate-scan-line {
            animation: scan-line 2s linear infinite;
        }
        /* แก้ไขปัญหาเนื้อหาถูก Footer บัง เพิ่มระยะให้เลื่อนได้สุด */
        main { padding-bottom: 240px; }
        #reader {
            width: 100% !important;
            border: none !important;
        }
        #reader video {
            border-radius: 1.5rem;
            object-fit: cover;
        }
        .ticket-cutout {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), 
                              radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        /* เพิ่มความลื่นไหลให้กับการเปลี่ยนหน้า */
        .page-transition {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen">

    <div id="app">
        <div class="flex items-center justify-center min-h-screen text-indigo-600">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-600 border-opacity-30"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbId = "smart-booking-v3"; 

        // --- App State ---
        window.state = {
            user: null,
            studentId: localStorage.getItem('student_id') || '',
            isLoggedIn: !!localStorage.getItem('student_id'),
            isAdmin: localStorage.getItem('is_admin') === 'true',
            settings: { 
                projectName: "General Booking Project",
                maxHoursPerDay: 2,
                maxTotalHours: 10,
                startTime: "09:00", 
                endTime: "18:00", 
                availableDays: [1, 2, 3, 4, 5], 
                startDate: new Date().toISOString().split('T')[0], 
                endDate: "" 
            },
            resources: [],
            bookings: [],
            selectedResource: null,
            selectedDate: new Date().toISOString().split('T')[0],
            selectedSlots: [],
            view: 'selection', // selection, calendar, pass, scanner
            activeBookings: [],
            error: null,
            showQRModal: null,
            isScanning: false
        };

        let html5QrScanner = null;
        const DAYS_TH = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];

        // --- Core Logics ---
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    window.state.user = u;
                    if (u) listenToData();
                });
            } catch (err) {
                showError("Connection Error: " + err.message);
            }
        }

        function listenToData() {
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), (s) => {
                if (s.exists()) window.state.settings = s.data();
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), (s) => {
                window.state.resources = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), (s) => {
                window.state.bookings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        function showError(msg) {
            window.state.error = msg;
            render();
            setTimeout(() => { window.state.error = null; render(); }, 6000);
        }

        // --- Exposed UI Actions ---
        window.render = render;
        window.setView = (v) => { 
            window.state.view = v; 
            if (v !== 'scanner' && html5QrScanner) {
                html5QrScanner.clear();
                html5QrScanner = null;
                window.state.isScanning = false;
            }
            render(); 
        };

        window.handleLogin = (e) => {
            e.preventDefault();
            const input = document.getElementById('login_sid').value.trim();
            if (input === "Admin123") {
                window.state.isAdmin = true;
                window.state.isLoggedIn = true;
                window.state.studentId = "ADMIN_MODE";
                localStorage.setItem('is_admin', 'true');
            } else if (input.length >= 5) {
                window.state.isAdmin = false;
                window.state.isLoggedIn = true;
                window.state.studentId = input;
                localStorage.setItem('student_id', input);
                localStorage.setItem('is_admin', 'false');
            } else {
                return showError("กรุณาระบุข้อมูลที่ถูกต้อง");
            }
            render();
        };

        window.logout = () => { 
            localStorage.clear();
            window.state.studentId = ''; 
            window.state.isLoggedIn = false; 
            window.state.isAdmin = false;
            window.state.view = 'selection';
            render(); 
        };

        window.selectResource = (id, name) => { 
            window.state.selectedResource = { id, name }; 
            window.state.selectedSlots = [];
            window.state.view = 'calendar'; 
            render(); 
        };

        window.toggleSlotSelection = (slot) => {
            const index = window.state.selectedSlots.indexOf(slot);
            if (index > -1) {
                window.state.selectedSlots.splice(index, 1);
            } else {
                // Check Daily Quota
                const dailyBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
                if (dailyBooked + window.state.selectedSlots.length >= window.state.settings.maxHoursPerDay) {
                    return showError(`โควตารายวันเต็ม! คุณจองได้สูงสุด ${window.state.settings.maxHoursPerDay} ชม./วัน`);
                }
                // Check Total Project Quota
                const totalBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;
                if (totalBooked + window.state.selectedSlots.length >= window.state.settings.maxTotalHours) {
                    return showError(`โควตารวมโปรเจกต์เต็ม! คุณจองได้สูงสุด ${window.state.settings.maxTotalHours} ชม. สำหรับงานนี้`);
                }
                window.state.selectedSlots.push(slot);
            }
            render();
        };

        window.confirmBookingAction = async () => {
            if (window.state.selectedSlots.length === 0) return;
            try {
                const newItems = [];
                for (const slot of window.state.selectedSlots) {
                    const data = {
                        resourceId: window.state.selectedResource.id,
                        resourceName: window.state.selectedResource.name,
                        date: window.state.selectedDate,
                        slot,
                        studentId: window.state.studentId,
                        email: `${window.state.studentId}@kmitl.ac.th`,
                        status: 'booked',
                        createdAt: serverTimestamp()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), data);
                    newItems.push({ id: docRef.id, ...data });
                }
                window.state.activeBookings = newItems;
                window.state.selectedSlots = [];
                window.state.view = 'pass';
                render();
            } catch (err) {
                showError("จองไม่สำเร็จ: " + err.message);
            }
        };

        window.initBookingScanner = () => {
            if (window.state.isScanning) return;
            window.state.isScanning = true;
            html5QrScanner = new Html5QrcodeScanner("reader", { 
                fps: 20, 
                qrbox: { width: 250, height: 250 }
            });
            html5QrScanner.render((decodedText) => {
                const targetId = window.state.activeBookings[0]?.resourceId;
                if (decodedText === targetId) {
                    if (isCheckInTimeValid()) {
                        html5QrScanner.clear().then(() => {
                            window.state.isScanning = false;
                            window.processBookingCheckIn(targetId);
                        });
                    } else {
                        showError("เช็คอินล้มเหลว: ยังไม่ถึงเวลาที่คุณจอง หรือเลยเวลาไปแล้ว");
                    }
                } else {
                    showError("QR ไม่ตรงกับอุปกรณ์ที่คุณจอง");
                }
            }, (err) => {});
        };

        const isCheckInTimeValid = () => {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            return window.state.activeBookings.some(b => {
                const bHour = parseInt(b.slot.split(':')[0]);
                return b.date === todayStr && currentHour === bHour;
            });
        };

        window.processBookingCheckIn = async (resId) => {
            for (const b of window.state.activeBookings) {
                await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), {
                    status: 'checked_in', checkInAt: new Date().toISOString()
                });
            }
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', resId), {
                status: 'in_use', currentStudent: window.state.studentId, startedAt: new Date().toISOString()
            });
            window.state.view = 'selection';
            window.state.selectedResource = null;
            window.state.activeBookings = [];
            alert("เช็คอินสำเร็จ! ระบบเริ่มบันทึกเวลาการเข้างานของคุณ");
            render();
        };

        window.releaseResource = async (id) => {
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id), {
                status: 'idle', currentStudent: null, startedAt: null
            });
        };

        window.saveAdminConfig = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const days = DAYS_TH.map((_, i) => f.get(`day-${i}`) ? i : null).filter(x => x !== null);
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                projectName: f.get('projectName'),
                maxHoursPerDay: parseInt(f.get('maxHoursDay')),
                maxTotalHours: parseInt(f.get('maxHoursTotal')),
                startTime: f.get('startTime'),
                endTime: f.get('endTime'),
                startDate: f.get('startDate'),
                endDate: f.get('endDate'),
                availableDays: days
            });
            alert("บันทึกการตั้งค่าแล้ว");
            render();
        };

        window.addNewResource = async (e) => {
            e.preventDefault();
            const name = e.target.resName.value.trim();
            if (!name) return;
            await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), { name, status: 'idle' });
            e.target.reset();
        };

        window.deleteBookingEntry = async (id) => {
            if(confirm("ลบการจองนี้หรือไม่?")) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', id));
        };

        window.wipeAllHistory = async () => {
            if(confirm("ต้องการลบประวัติทั้งหมดใช่หรือไม่?")) {
                for (const b of window.state.bookings) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
            }
        };

        window.openQRModal = (id, name) => { window.state.showQRModal = { id, name }; render(); };
        window.closeQRModal = () => { window.state.showQRModal = null; render(); };

        const isDateInActiveService = () => {
            const dateObj = new Date(window.state.selectedDate);
            const dayOfWeek = dateObj.getDay();
            const isInRange = (!window.state.settings.startDate || window.state.selectedDate >= window.state.settings.startDate) &&
                              (!window.state.settings.endDate || window.state.selectedDate <= window.state.settings.endDate);
            return isInRange && window.state.settings.availableDays.includes(dayOfWeek);
        };

        // --- Render Engine ---
        function render() {
            const appDiv = document.getElementById('app');
            if (!window.state.isLoggedIn) {
                appDiv.innerHTML = renderLogin();
            } else {
                appDiv.innerHTML = `
                    ${renderHeader()}
                    <main class="max-w-xl mx-auto px-4 py-6 md:py-8 page-transition">
                        ${window.state.error ? renderError() : ''}
                        ${window.state.isAdmin ? renderAdminUI() : renderUserUI()}
                    </main>
                    ${renderFooter()}
                    ${window.state.showQRModal ? renderQRModal() : ''}
                `;
            }
            lucide.createIcons();
            if (window.state.view === 'scanner') setTimeout(window.initBookingScanner, 100);
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-6">
                    <div class="max-w-sm w-full bg-white rounded-3xl p-8 shadow-xl border border-slate-100 text-center animate-in fade-in zoom-in duration-300">
                        <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-indigo-100"><i data-lucide="user-check" size="32"></i></div>
                        <h1 class="text-3xl font-bold text-slate-800 mb-1 leading-tight">SmartBooking</h1>
                        <p class="text-slate-400 text-xs font-medium mb-10 tracking-widest uppercase">Identity Pass</p>
                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div class="text-left space-y-2">
                                <label class="text-[10px] font-bold uppercase text-slate-400 ml-4 tracking-widest">Identification</label>
                                <input id="login_sid" type="text" placeholder="รหัสนักศึกษา" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-100 font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-center placeholder:text-slate-300 shadow-inner" required>
                            </div>
                            <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg hover:bg-indigo-700 transition-all active:scale-95 text-lg">เริ่มต้นใช้งาน</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-white/80 backdrop-blur-md border-b border-slate-100 sticky top-0 z-50">
                    <div class="max-w-2xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-2 cursor-pointer group" onclick="setView('selection'); window.state.selectedResource=null; render();">
                            <div class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-md active:scale-90 transition-transform"><i data-lucide="layers" size="18"></i></div>
                            <div>
                                <h1 class="font-bold text-base leading-none text-slate-800">SmartBooking</h1>
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-1">${window.state.settings.projectName}</p>
                            </div>
                        </div>
                        <button onclick="logout()" class="p-2 bg-slate-50 text-slate-400 hover:text-red-500 rounded-xl border border-slate-100 active:scale-90 transition-all"><i data-lucide="log-out" size="18"></i></button>
                    </div>
                </header>
            `;
        }

        function renderUserUI() {
            if (window.state.view === 'scanner') return renderScannerUI();
            if (window.state.view === 'pass') return renderReceiptUI();
            if (!window.state.selectedResource) return renderResourcesUI();
            return renderCalendarUI();
        }

        function renderResourcesUI() {
            return `
                <div class="space-y-6">
                    <div class="bg-indigo-600 p-6 rounded-3xl text-white shadow-xl relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        <p class="text-[9px] font-bold uppercase tracking-widest opacity-60 mb-1 leading-none">Session Identity</p>
                        <h2 class="text-3xl font-black tracking-tighter leading-none">${window.state.studentId}</h2>
                        <div class="flex items-center gap-2 text-indigo-200 text-[10px] font-bold mt-6 bg-white/10 w-fit px-3 py-1.5 rounded-xl border border-white/5 uppercase tracking-wider">
                            <div class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse shadow-[0_0_8px_#4ade80]"></div>
                            <span>Cloud Live Synced</span>
                        </div>
                    </div>
                    
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 leading-none">รายการทรัพยากร / สถานที่</h3>
                    <div class="grid grid-cols-1 gap-3">
                        ${window.state.resources.map(res => `
                            <button onclick="selectResource('${res.id}', '${res.name}')" class="group bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-indigo-200 transition-all text-left flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-11 h-11 rounded-xl flex items-center justify-center transition-all ${res.status === 'in_use' ? 'bg-orange-50 text-orange-500' : 'bg-slate-50 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white'}">
                                        <i data-lucide="map-pin" size="20"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-base text-slate-800 leading-tight">${res.name}</h3>
                                        <div class="flex items-center gap-1.5 mt-0.5 leading-none">
                                            <div class="w-2 h-2 rounded-full ${res.status === 'in_use' ? 'bg-orange-400 animate-pulse' : 'bg-green-400'}"></div>
                                            <span class="text-[9px] font-bold uppercase tracking-widest ${res.status === 'in_use' ? 'text-orange-500' : 'text-green-500'}">
                                                ${res.status === 'in_use' ? `In Use by ${res.currentStudent}` : 'Ready'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-slate-200 group-hover:text-indigo-600 transition-all">
                                    <i data-lucide="chevron-right" size="20"></i>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCalendarUI() {
            const startH = parseInt(window.state.settings.startTime.split(':')[0]);
            const endH = parseInt(window.state.settings.endTime.split(':')[0]);
            const slots = [];
            for(let i=startH; i<endH; i++) slots.push(`${i.toString().padStart(2, '0')}:00`);
            
            const bookedDaily = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
            const bookedTotal = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;

            return `
                <div class="space-y-4">
                    <button onclick="setView('selection'); window.state.selectedResource=null; render();" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 text-[10px] font-bold uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="arrow-left" size="14"></i> เปลี่ยนจุดจอง</button>
                    
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-xl space-y-6">
                        <div class="flex items-center gap-3 text-indigo-600 leading-none">
                            <div class="w-9 h-9 bg-indigo-50 rounded-lg flex items-center justify-center"><i data-lucide="calendar" size="18"></i></div>
                            <div>
                                <h2 class="text-lg font-bold text-slate-800">${window.state.selectedResource.name}</h2>
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-1">Resource Schedule</p>
                            </div>
                        </div>
                        
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold uppercase text-slate-400 ml-2">ระบุวันที่</label>
                            <input type="date" value="${window.state.selectedDate}" onchange="window.state.selectedDate=this.value; window.state.selectedSlots=[]; render();" class="w-full p-3.5 rounded-xl bg-slate-50 border border-slate-100 font-bold text-slate-800 text-center shadow-inner outline-none focus:ring-1 focus:ring-indigo-300">
                        </div>

                        ${!isDateInActiveService() ? `
                            <div class="p-10 bg-orange-50 rounded-2xl text-center space-y-2">
                                <i data-lucide="clock-alert" size="32" class="mx-auto text-orange-300"></i>
                                <p class="font-bold text-orange-700 text-sm">ไม่เปิดให้บริการ</p>
                                <p class="text-[10px] text-orange-600 leading-relaxed opacity-70">กรุณาเลือกวันที่ตรงกับตารางโครงการ</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-indigo-600 p-4 rounded-2xl text-white shadow-md relative overflow-hidden">
                                    <p class="text-[8px] font-bold uppercase opacity-60 mb-1 leading-none">Daily Quota</p>
                                    <p class="text-2xl font-black leading-none">${bookedDaily + window.state.selectedSlots.length} / ${window.state.settings.maxHoursPerDay} <span class="text-[10px] opacity-40">ชม.</span></p>
                                    <div class="w-full h-1 bg-white/20 rounded-full mt-3 overflow-hidden shadow-inner">
                                        <div class="h-full bg-white transition-all" style="width: ${((bookedDaily + window.state.selectedSlots.length) / window.state.settings.maxHoursPerDay) * 100}%"></div>
                                    </div>
                                </div>
                                <div class="bg-slate-900 p-4 rounded-2xl text-white shadow-md relative overflow-hidden">
                                    <p class="text-[8px] font-bold uppercase opacity-60 mb-1 leading-none">Total Quota</p>
                                    <p class="text-2xl font-black leading-none">${bookedTotal + window.state.selectedSlots.length} / ${window.state.settings.maxTotalHours} <span class="text-[10px] opacity-40">ชม.</span></p>
                                    <div class="w-full h-1 bg-indigo-500/30 rounded-full mt-3 overflow-hidden shadow-inner">
                                        <div class="h-full bg-indigo-400 transition-all" style="width: ${((bookedTotal + window.state.selectedSlots.length) / window.state.settings.maxTotalHours) * 100}%"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 gap-2.5">
                                ${slots.map(slot => {
                                    const bOthers = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id && b.studentId !== window.state.studentId);
                                    const bMine = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === slot && b.resourceId === window.state.selectedResource.id && b.studentId === window.state.studentId);
                                    const isSelecting = window.state.selectedSlots.includes(slot);
                                    
                                    let btnClass = "bg-white border-slate-100 text-slate-500 hover:border-indigo-300 active:scale-[0.98]";
                                    let statusText = "Ready to Book";
                                    let action = `toggleSlotSelection('${slot}')`;

                                    if (bOthers) {
                                        btnClass = "bg-slate-100 border-slate-100 text-slate-300 opacity-50 cursor-not-allowed";
                                        statusText = `Booked by ID:${bOthers.studentId.slice(-4)}`;
                                        action = "";
                                    } else if (bMine) {
                                        btnClass = "bg-green-50 border-green-500 text-green-700 shadow-sm";
                                        statusText = "จองแล้ว (คลิกเพื่อยกเลิก)";
                                        action = `deleteBookingEntry('${bMine.id}')`;
                                    } else if (isSelecting) {
                                        btnClass = "bg-indigo-600 border-indigo-600 text-white shadow-md scale-[1.01] z-10";
                                        statusText = "Selected";
                                        action = `toggleSlotSelection('${slot}')`;
                                    }

                                    return `
                                        <button onclick="${action}" class="relative p-4 rounded-xl border-2 transition-all flex justify-between items-center ${btnClass}">
                                            <div class="text-left leading-none">
                                                <span class="text-base font-bold">${slot} - ${slot.split(':')[0]}:59</span>
                                                <p class="text-[8px] font-bold uppercase mt-1 opacity-60">${statusText}</p>
                                            </div>
                                            <div class="w-7 h-7 rounded-full flex items-center justify-center ${bMine || isSelecting ? 'bg-white/20' : 'bg-slate-50'} shadow-inner transition-transform active:scale-75">
                                                ${bMine || isSelecting ? '<i data-lucide="check" size="14"></i>' : '<i data-lucide="plus" size="14" class="opacity-30"></i>'}
                                            </div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>

                            ${window.state.selectedSlots.length > 0 ? `
                                <div class="fixed bottom-28 left-0 right-0 px-6 z-40 max-w-xl mx-auto animate-in slide-in-from-bottom-10">
                                    <button onclick="confirmBookingAction()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl transition-all active:scale-95 text-lg flex items-center justify-center gap-3 border-b-4 border-indigo-800">
                                        <i data-lucide="check-square" size="20"></i>
                                        ยืนยันจอง ${window.state.selectedSlots.length} ช่วงเวลา
                                    </button>
                                </div>
                            ` : ''}
                        `}
                    </div>
                </div>
            `;
        }

        function renderReceiptUI() {
            const dateStr = window.state.activeBookings[0]?.date;
            const resName = window.state.activeBookings[0]?.resourceName;

            return `
                <div class="max-w-sm mx-auto py-2 animate-in zoom-in duration-500">
                    <div class="bg-white rounded-3xl overflow-hidden shadow-2xl border border-slate-100 relative">
                        <div class="bg-indigo-600 p-8 text-white text-center relative overflow-hidden">
                            <i data-lucide="shield-check" size="36" class="mx-auto mb-3 opacity-60"></i>
                            <h2 class="text-2xl font-bold mb-0.5">จองสำเร็จ</h2>
                            <p class="text-indigo-200 text-[8px] font-bold uppercase tracking-widest opacity-60 leading-none">Booking Identification Pass</p>
                        </div>
                        <div class="p-8 space-y-6 ticket-cutout">
                            <div class="space-y-5">
                                <div class="pb-4 border-b border-slate-100"><p class="text-[9px] font-bold text-slate-400 uppercase mb-1">อุปกรณ์ / สถานที่</p><p class="text-xl font-bold text-slate-800 leading-tight">${resName}</p></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><p class="text-[9px] font-bold text-slate-400 uppercase mb-1 leading-none">รหัสผู้จอง</p><p class="text-base font-bold">${window.state.studentId}</p></div>
                                    <div><p class="text-[9px] font-bold text-slate-400 uppercase mb-1 leading-none">วันที่</p><p class="text-base font-bold">${dateStr}</p></div>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 text-center">
                                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-3 leading-none">ช่วงเวลาที่ได้รับการอนุมัติ</p>
                                    <div class="flex flex-wrap justify-center gap-2">
                                        ${window.state.activeBookings.map(b => `<span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-[10px] font-bold">${b.slot}</span>`).join('')}
                                    </div>
                                    <div class="mt-6 flex items-center gap-2 justify-center text-blue-600 bg-white p-3 rounded-xl border border-blue-50">
                                        <i data-lucide="check-circle" size="14"></i>
                                        <p class="text-[8px] font-bold uppercase leading-none">เมลส่งไปที่ ${window.state.studentId}@kmitl.ac.th</p>
                                    </div>
                                </div>
                            </div>
                            <div class="pt-6 border-t-2 border-dashed border-slate-100">
                                <button onclick="setView('scanner')" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl flex items-center justify-center gap-2 shadow-lg hover:bg-black transition-all active:scale-95">
                                    <i data-lucide="qr-code" size="20"></i> เปิดสแกนเช็คอิน
                                </button>
                                <button onclick="setView('selection'); window.state.activeBookings=[]; render();" class="w-full mt-5 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">กลับสู่หน้าหลัก</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScannerUI() {
            return `
                <div class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-6 text-white animate-in fade-in duration-500">
                    <div class="w-full max-w-sm text-center">
                        <div class="mb-10">
                            <h2 class="text-2xl font-bold mb-1 tracking-tight leading-none">เช็คอินเข้าใช้งาน</h2>
                            <p class="text-slate-400 text-xs font-medium uppercase tracking-widest opacity-70">Scan Surface QR Code</p>
                        </div>
                        
                        <div class="relative w-full aspect-square bg-black rounded-3xl overflow-hidden border-8 border-white/5 shadow-2xl">
                            <div id="reader" class="w-full h-full"></div>
                            <div class="absolute inset-0 pointer-events-none border-[3rem] border-slate-900/60 z-10 shadow-inner"></div>
                            <div class="absolute top-1/2 left-0 right-0 h-1 bg-indigo-500 shadow-[0_0_20px_#6366f1] animate-scan-line z-20"></div>
                        </div>

                        <div class="mt-12 space-y-4">
                            <div class="bg-white/5 border border-white/10 p-4 rounded-2xl">
                                <p class="text-[8px] font-bold uppercase tracking-widest text-indigo-400 mb-1 leading-none">Target Unit</p>
                                <p class="font-bold text-base leading-none">${window.state.activeBookings[0]?.resourceName}</p>
                            </div>
                            <button onclick="setView('pass')" class="w-full py-3.5 bg-white/5 text-white font-bold rounded-2xl border border-white/10 text-[10px] uppercase tracking-widest">ยกเลิก</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminUI() {
            return `
                <div class="space-y-8 animate-in fade-in duration-700 pb-20">
                    <section class="bg-white p-8 rounded-3xl border border-slate-100 shadow-xl space-y-8 border-t-8 border-indigo-600">
                        <div class="flex items-center gap-3 text-indigo-600"><i data-lucide="settings-2" size="24"></i><h2 class="text-lg font-bold">Project Configuration</h2></div>
                        <form onsubmit="saveAdminConfig(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 space-y-2">
                                <label class="text-[10px] font-bold uppercase text-slate-400 ml-2 tracking-widest leading-none">Project Name</label>
                                <input name="projectName" type="text" value="${window.state.settings.projectName}" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 font-bold outline-none text-base shadow-inner" required>
                            </div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-2">เริ่มวันที่</label><input name="startDate" type="date" value="${window.state.settings.startDate}" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 font-bold shadow-inner"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-2">สิ้นสุดวันที่</label><input name="endDate" type="date" value="${window.state.settings.endDate}" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 font-bold shadow-inner"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-2">เวลาเปิด</label><input name="startTime" type="time" value="${window.state.settings.startTime}" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 font-bold shadow-inner"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-2">เวลาปิด</label><input name="endTime" type="time" value="${window.state.settings.endTime}" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 font-bold shadow-inner"></div>
                            
                            <div class="md:col-span-2 space-y-3">
                                <label class="text-[10px] font-bold uppercase text-slate-400 ml-2">Operating Days</label>
                                <div class="flex flex-wrap gap-2">
                                    ${DAYS_TH.map((d, i) => `
                                        <label class="flex items-center gap-2 bg-slate-50 px-4 py-3 rounded-xl border border-slate-100 text-[9px] font-bold uppercase cursor-pointer hover:bg-indigo-50 transition-all group">
                                            <input type="checkbox" name="day-${i}" ${window.state.settings.availableDays.includes(i) ? 'checked' : ''} class="w-4 h-4 rounded text-indigo-600 transition-all"> <span class="group-hover:text-indigo-600">${d}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold uppercase text-slate-400 ml-2">โควตารายวัน (ชม./คน)</label>
                                <input name="maxHoursDay" type="number" value="${window.state.settings.maxHoursPerDay}" class="w-full p-4 rounded-xl bg-indigo-50 border border-indigo-100 font-bold text-xl text-indigo-600 shadow-inner">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold uppercase text-slate-400 ml-2">โควตารวม (ชม./คน)</label>
                                <input name="maxHoursTotal" type="number" value="${window.state.settings.maxTotalHours}" class="w-full p-4 rounded-xl bg-indigo-50 border border-indigo-100 font-bold text-xl text-indigo-600 shadow-inner">
                            </div>
                            
                            <div class="md:col-span-2 pt-4">
                                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg hover:bg-indigo-700 active:scale-[0.98] border-b-4 border-indigo-800 uppercase tracking-widest text-sm">Save Global Project Settings</button>
                            </div>
                        </form>
                    </section>

                    <section class="bg-white p-8 rounded-3xl border border-slate-100 shadow-xl space-y-6">
                        <div class="flex items-center gap-3 text-indigo-600"><i data-lucide="package-plus" size="24"></i><h2 class="text-lg font-bold">Resource Inventory</h2></div>
                        <form onsubmit="addNewResource(event)" class="flex gap-3">
                            <input name="resName" placeholder="เพิ่มรายการใหม่..." class="flex-1 p-4 rounded-xl bg-slate-50 border border-slate-100 font-bold outline-none focus:ring-1 focus:ring-indigo-300 shadow-inner" required>
                            <button type="submit" class="px-8 bg-slate-900 text-white font-bold rounded-xl hover:bg-black transition-all active:scale-95 text-[10px] uppercase tracking-widest">Enroll</button>
                        </form>
                        <div class="grid grid-cols-1 gap-3">
                            ${window.state.resources.map(res => `
                                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100 group hover:border-indigo-200">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-300 border border-slate-50"><i data-lucide="box" size="20"></i></div>
                                        <div><p class="font-bold text-slate-800 text-sm leading-tight">${res.name}</p><p class="text-[8px] text-slate-400 font-bold uppercase mt-1 tracking-widest">UID: ${res.id}</p></div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="openQRModal('${res.id}', '${res.name}')" class="p-2.5 bg-white text-indigo-600 rounded-xl shadow-sm border border-slate-100 hover:bg-indigo-600 hover:text-white transition-all active:scale-90 shadow-sm"><i data-lucide="qr-code" size="18"></i></button>
                                        <button onclick="deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', '${res.id}'))" class="p-2.5 bg-white text-red-400 rounded-xl shadow-sm border border-slate-100 hover:bg-red-50 active:scale-90 shadow-sm"><i data-lucide="trash-2" size="18"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <section class="bg-white p-8 rounded-3xl border border-slate-100 shadow-xl space-y-6 overflow-hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="flex items-center gap-3 text-indigo-600 leading-none"><i data-lucide="history" size="24"></i><h2 class="text-lg font-bold">Booking Activity Log</h2></div>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="clearHistoryByDay()" class="flex-1 sm:flex-none px-4 py-2 bg-slate-100 text-slate-600 text-[9px] font-bold uppercase rounded-xl hover:bg-slate-200 tracking-widest">ลบตามวัน</button>
                                <button onclick="wipeAllHistory()" class="flex-1 sm:flex-none px-4 py-2 bg-red-50 text-red-500 text-[9px] font-bold uppercase rounded-xl border border-red-100 shadow-sm tracking-widest">ล้างทั้งหมด</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="w-full text-left">
                                <thead class="border-b-2 border-slate-50 text-[9px] font-bold uppercase text-slate-400 tracking-widest">
                                    <tr>
                                        <th class="py-4">TIMESTAMP</th>
                                        <th class="py-4">ENTITY</th>
                                        <th class="py-4 text-center">IDENTITY</th>
                                        <th class="py-4"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${window.state.bookings.slice().sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(b => `
                                        <tr class="group hover:bg-slate-50/50 transition-colors">
                                            <td class="py-4 leading-tight">
                                                <p class="font-bold text-slate-800 text-[13px] tracking-tight">${b.date}</p>
                                                <p class="text-[9px] text-indigo-500 font-bold mt-0.5 uppercase">${b.slot} - ${b.slot.split(':')[0]}:59</p>
                                            </td>
                                            <td class="py-4 leading-tight">
                                                <p class="text-slate-800 font-bold text-[13px] leading-tight">${b.studentId}</p>
                                                <p class="text-[8px] text-slate-400 font-bold uppercase mt-0.5 tracking-widest truncate max-w-[100px]">${b.resourceName}</p>
                                            </td>
                                            <td class="py-4 text-center">
                                                ${b.status === 'checked_in' ? `
                                                    <span class="px-2 py-0.5 bg-green-100 text-green-600 text-[7px] font-bold rounded-full uppercase border border-green-200">Arrived</span>
                                                ` : `
                                                    <span class="px-2 py-0.5 bg-slate-100 text-slate-400 text-[7px] font-bold rounded-full uppercase border border-slate-200 opacity-50">Wait</span>
                                                `}
                                            </td>
                                            <td class="py-4 text-right">
                                                <button onclick="deleteBookingEntry('${b.id}')" class="p-1.5 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all active:scale-75"><i data-lucide="trash-2" size="16"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
        }

        function renderQRModal() {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${window.state.showQRModal.id}`;
            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[200] flex items-center justify-center p-6 no-print">
                    <div class="bg-white rounded-[3.5rem] p-10 max-w-sm w-full text-center relative shadow-2xl animate-in zoom-in duration-300 border-t-8 border-indigo-600">
                        <button onclick="closeQRModal()" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-800 transition-all active:scale-75"><i data-lucide="x" size="28"></i></button>
                        <h3 class="text-2xl font-bold mb-1 text-slate-800 tracking-tight uppercase leading-none">${window.state.showQRModal.name}</h3>
                        <p class="text-[8px] font-bold text-slate-400 uppercase tracking-[0.4em] mb-10 leading-none">Security Hardware Key</p>
                        <div class="bg-slate-50 p-8 rounded-3xl mb-10 flex items-center justify-center border-4 border-slate-50 shadow-inner">
                            <img src="${qrUrl}" alt="QR" class="w-[180px] h-[180px] rounded-2xl shadow-xl">
                        </div>
                        <button onclick="window.print()" class="w-full py-5 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-3 active:translate-y-1"><i data-lucide="printer" size="20"></i> พิมพ์รหัส QR</button>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <footer class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-100 py-8 px-8 z-40 shadow-[0_-15px_40px_rgba(0,0,0,0.04)]">
                    <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">
                        <div class="flex items-center gap-3 border-r pr-6 border-slate-100">
                            <div class="w-9 h-9 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-400 shadow-inner leading-none"><i data-lucide="fingerprint" size="16"></i></div>
                            <div>
                                <p class="text-[6px] opacity-60 leading-none mb-1">Session ID</p>
                                <p class="text-slate-800 leading-none">${window.state.studentId || 'AUTHENTICATING'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 text-green-500 bg-green-50/50 px-4 py-2.5 rounded-xl border border-green-100 leading-none">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#4ade80]"></div> 
                            <span>Node Live Sync</span>
                        </div>
                    </div>
                </footer>
            `;
        }

        function renderError() {
            return `
                <div class="mb-8 p-4 bg-red-50 border border-red-100 text-red-600 rounded-2xl text-[10px] font-bold flex items-center gap-4 animate-in slide-in-from-top-4 shadow-sm">
                    <div class="w-8 h-8 bg-red-100 rounded-xl flex items-center justify-center shrink-0 shadow-inner border border-red-200 leading-none"><i data-lucide="alert-octagon" size="18"></i></div>
                    <p class="flex-1 uppercase tracking-widest leading-relaxed">${String(window.state.error)}</p>
                    <button onclick="window.state.error=null; render();" class="text-red-300 hover:text-red-600 p-1 active:scale-75 transition-transform"><i data-lucide="x-circle" size="22"></i></button>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
