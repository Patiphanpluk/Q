<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartBooking - ระบบจองใช้งานทรัพยากร</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Prompt', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; overflow: hidden; height: 100vh; background-color: #f8fafc; margin:0; padding:0; }
        #app { height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 160px; 
        }

        @keyframes scan-line {
            0% { top: 10%; }
            100% { top: 90%; }
        }
        .animate-scan-line { animation: scan-line 2s linear infinite; }
        
        #reader { width: 100% !important; border: none !important; position: relative; aspect-ratio: 1/1; overflow: hidden; background: #000; }
        #reader video { border-radius: 2rem; object-fit: cover !important; width: 100% !important; height: 100% !important; }
        
        .ticket-cutout {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), 
                              radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .page-transition { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
    </style>
</head>
<body class="text-slate-900">

    <div id="app">
        <div class="flex items-center justify-center h-full text-indigo-600">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-600 border-opacity-30"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbId = "smart-booking-v4"; 

        window.state = {
            user: null,
            studentId: localStorage.getItem('student_id') || '',
            isLoggedIn: !!localStorage.getItem('student_id'),
            isAdmin: localStorage.getItem('is_admin') === 'true',
            settings: { 
                projectName: "Global Access Project",
                maxHoursPerDay: 2,
                maxTotalHours: 10,
                startTime: "09:00", 
                endTime: "18:00", 
                availableDays: [1, 2, 3, 4, 5], 
                startDate: new Date().toISOString().split('T')[0], 
                endDate: "" 
            },
            allowedStudents: [], // New whitelist
            resources: [],
            bookings: [],
            selectedResource: null,
            selectedDate: new Date().toISOString().split('T')[0],
            calendarViewDate: new Date(), 
            publicSelectedResourceId: '', // For multi-resource selector in public view
            selectedSlots: [], 
            view: 'login', 
            activeBookings: [],
            modal: { show: false, title: '', message: '', type: 'info', onConfirm: null },
            showQRModal: null,
            isScanning: false,
            isProcessingScan: false 
        };

        const DAYS_TH = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];
        const MONTHS_TH = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];

        // --- Logic: Utilities ---
        function addMinutes(time, mins) {
            let [h, m] = time.split(':').map(Number);
            let date = new Date(2000, 0, 1, h, m + mins);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDateTH(dateStr) {
            if (!dateStr) return "-";
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function formatDateTime(ts) {
            if (!ts) return "-";
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return d.toLocaleString('th-TH', { hour12: false });
        }

        window.formatBookingRanges = (bookingList) => {
            if (!bookingList || bookingList.length === 0) return "ไม่มีข้อมูลเวลา";
            const sorted = [...bookingList].sort((a, b) => a.slot.localeCompare(b.slot));
            let ranges = [];
            if (sorted.length > 0) {
                let start = sorted[0].slot;
                let currentEnd = sorted[0].slot_end || addMinutes(start, 59);
                for (let i = 1; i < sorted.length; i++) {
                    if (sorted[i].slot === currentEnd || sorted[i].slot === addMinutes(currentEnd, 1)) {
                        currentEnd = sorted[i].slot_end || addMinutes(sorted[i].slot, 59);
                    } else {
                        ranges.push(`${start} - ${currentEnd}`);
                        start = sorted[i].slot;
                        currentEnd = sorted[i].slot_end || addMinutes(start, 59);
                    }
                }
                ranges.push(`${start} - ${currentEnd}`);
            }
            return ranges.join(", ");
        };

        // --- Firebase Core ---
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    window.state.user = u;
                    if (u) listenToData();
                });
            } catch (err) { window.uiAlert("Firebase Error: " + err.message, "error"); }
        }

        function listenToData() {
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), (s) => {
                if (s.exists()) window.state.settings = s.data();
                render();
            });
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'allowed_students'), (s) => {
                if (s.exists()) window.state.allowedStudents = s.data().list || [];
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), (s) => {
                window.state.resources = s.docs.map(d => ({ id: d.id, ...d.data() }));
                if (window.state.resources.length > 0 && !window.state.publicSelectedResourceId) {
                    window.state.publicSelectedResourceId = window.state.resources[0].id;
                }
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), (s) => {
                window.state.bookings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        // --- UI Modal Logic ---
        window.uiAlert = (message, type = 'info') => {
            window.state.modal = { show: true, title: type === 'error' ? 'ข้อผิดพลาด' : type === 'success' ? 'สำเร็จ' : 'แจ้งเตือน', message, type, onConfirm: null };
            render();
        };

        window.uiConfirm = (title, message, onConfirm) => {
            window.state.modal = { show: true, title, message, type: 'confirm', onConfirm };
            render();
        };

        window.closeModal = () => { window.state.modal.show = false; render(); };

        // --- Actions ---
        window.render = render;
        window.setView = (v) => { 
            window.state.view = v; 
            if (v !== 'scanner' && window.html5QrScanner) {
                if (window.html5QrScanner.stop) { window.html5QrScanner.stop().catch(() => {}); }
                else if (window.html5QrScanner.clear) { window.html5QrScanner.clear(); }
                window.html5QrScanner = null;
                window.state.isScanning = false;
                window.state.isProcessingScan = false;
            }
            render(); 
        };

        window.handleLogin = (e) => {
            e.preventDefault();
            const input = document.getElementById('login_sid').value.trim();
            if (input === "Admin123") {
                window.state.isAdmin = true;
                window.state.isLoggedIn = true;
                window.state.studentId = "ADMIN";
                localStorage.setItem('is_admin', 'true');
            } else if (input.length >= 5) {
                // Check whitelist
                if (window.state.allowedStudents.length > 0 && !window.state.allowedStudents.includes(input)) {
                    return window.uiAlert("รหัสนักศึกษานี้ไม่ได้รับอนุญาตให้ใช้งานระบบ\nกรุณาติดต่อผู้ดูแลระบบ", "error");
                }
                window.state.isAdmin = false;
                window.state.isLoggedIn = true;
                window.state.studentId = input;
                localStorage.setItem('student_id', input);
                localStorage.setItem('is_admin', 'false');
            } else { return window.uiAlert("กรุณาระบุข้อมูลที่ถูกต้อง", "error"); }
            window.state.view = 'selection';
            render();
        };

        window.logout = () => { 
            window.uiConfirm("ออกจากระบบ", "คุณต้องการออกจากระบบใช่หรือไม่?", () => {
                localStorage.clear();
                window.state.isLoggedIn = false; 
                window.state.isAdmin = false;
                window.state.view = 'login';
                render();
            });
        };

        window.selectResource = (id, name) => { 
            window.state.selectedResource = { id, name }; 
            window.state.selectedSlots = [];
            window.state.view = 'calendar'; 
            render(); 
        };

        window.toggleSlotSelection = (slotObj) => {
            const index = window.state.selectedSlots.findIndex(s => s.start === slotObj.start);
            if (index > -1) {
                window.state.selectedSlots.splice(index, 1);
            } else {
                const dailyBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
                if (dailyBooked + window.state.selectedSlots.length >= window.state.settings.maxHoursPerDay) {
                    return window.uiAlert(`เกินโควตาต่อวัน! (${window.state.settings.maxHoursPerDay} ชม./วัน)`, "error");
                }
                const totalBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;
                if (totalBooked + window.state.selectedSlots.length >= window.state.settings.maxTotalHours) {
                    return window.uiAlert(`เกินโควตาทั้งหมด! (${window.state.settings.maxTotalHours} ชม. ต่อโปรเจกต์)`, "error");
                }
                window.state.selectedSlots.push(slotObj);
            }
            render();
        };

        window.confirmBookingAction = async () => {
            if (window.state.selectedSlots.length === 0) return;
            try {
                const newItems = [];
                for (const slotObj of window.state.selectedSlots) {
                    const data = {
                        resourceId: window.state.selectedResource.id,
                        resourceName: window.state.selectedResource.name,
                        date: window.state.selectedDate,
                        slot: slotObj.start,
                        slot_end: slotObj.end,
                        studentId: window.state.studentId,
                        status: 'booked',
                        createdAt: serverTimestamp()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), data);
                    newItems.push({ id: docRef.id, ...data });
                }
                window.state.activeBookings = newItems;
                window.state.selectedSlots = [];
                window.uiAlert(`จองสำเร็จ!`, "success");
                window.state.view = 'pass';
                render();
            } catch (err) { window.uiAlert("Booking failed: " + err.message, "error"); }
        };

        window.viewPass = (list) => { window.state.activeBookings = list; window.state.view = 'pass'; render(); };

        window.initScanner = () => {
            if (window.state.isScanning) return;
            window.state.isScanning = true;
            window.state.isProcessingScan = false;
            window.html5QrScanner = new Html5Qrcode("reader");
            window.html5QrScanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 280, aspectRatio: 1.0 }, async (text) => {
                if (window.state.isProcessingScan) return;
                window.state.isProcessingScan = true;
                const targetId = window.state.activeBookings[0]?.resourceId;
                if (text === targetId) {
                    const now = new Date();
                    const currentMin = now.getHours() * 60 + now.getMinutes();
                    const today = now.toISOString().split('T')[0];
                    const relevant = window.state.activeBookings.filter(b => b.date === today);
                    if (relevant.length === 0) return stopScannerAndError("ไม่มีรายการจองในวันนี้");
                    const startMin = relevant.map(b => b.slot.split(':').map(Number)).map(([h,m]) => h*60+m).sort((a,b)=>a-b)[0];
                    if (currentMin >= (startMin - 60)) {
                        window.html5QrScanner.stop().then(() => { window.state.isScanning = false; window.processCheckIn(targetId); });
                    } else { await stopScannerAndError(`เช็คอินก่อนเวลาได้ 1 ชม. รออีก ${startMin-60-currentMin} นาที`); }
                } else { await stopScannerAndError("รหัสคิวอาร์ไม่ถูกต้อง"); }
            }, () => {}).catch(err => { window.state.isScanning = false; window.uiAlert("กล้องขัดข้อง: " + err, "error"); window.setView('pass'); });
        };

        async function stopScannerAndError(msg) {
            if (window.html5QrScanner) await window.html5QrScanner.stop().catch(() => {});
            window.state.isScanning = false;
            window.state.isProcessingScan = false;
            window.uiAlert(msg, "error");
            window.setView('pass');
        }

        window.processCheckIn = async (resId) => {
            for (const b of window.state.activeBookings) await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), { status: 'checked_in', checkInAt: new Date().toISOString() });
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', resId), { status: 'in_use', currentStudent: window.state.studentId, startedAt: new Date().toISOString() });
            window.state.view = 'selection';
            window.state.activeBookings = [];
            window.uiAlert("เช็คอินสำเร็จ!");
        };

        window.saveSettings = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const days = DAYS_TH.map((_, i) => f.get(`day-${i}`) ? i : null).filter(x => x !== null);
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                projectName: f.get('projectName'),
                maxHoursPerDay: parseInt(f.get('maxHoursDay')),
                maxTotalHours: parseInt(f.get('maxHoursTotal')),
                startTime: f.get('startTime'),
                endTime: f.get('endTime'),
                startDate: f.get('startDate'),
                endDate: f.get('endDate'),
                availableDays: days
            });
            window.uiAlert("บันทึกการตั้งค่าเรียบร้อยแล้ว");
        };

        window.saveWhitelist = async (e) => {
            e.preventDefault();
            const raw = e.target.studentsList.value;
            // Split by newline, tab, or space and clean up
            const list = raw.split(/[\n\t\r\s,]+/).map(s => s.trim()).filter(s => s.length >= 5);
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'allowed_students'), {
                list: [...new Set(list)], // Remove duplicates
                updatedAt: serverTimestamp()
            });
            window.uiAlert(`บันทึกรายชื่อที่อนุญาต ${list.length} รายการสำเร็จ`);
        };

        window.addRes = async (e) => {
            e.preventDefault();
            const name = e.target.resName.value.trim();
            if (name) await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), { name, status: 'idle' });
            e.target.reset();
        };

        window.deleteResource = (id) => window.uiConfirm("ลบทรัพยากร", "ต้องการลบรายการนี้ใช่หรือไม่?", async () => await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id)));
        
        window.delBooking = (id) => {
            const booking = window.state.bookings.find(b => b.id === id);
            if (!booking) return;
            const today = new Date(); today.setHours(0,0,0,0);
            const bDate = new Date(booking.date); bDate.setHours(0,0,0,0);
            if ((bDate.getTime() - today.getTime()) < (1000 * 60 * 60 * 24)) return window.uiAlert("ยกเลิกได้ล่วงหน้าอย่างน้อย 1 วัน", "error");
            window.uiConfirm("ยกเลิกการจอง", "ต้องการยกเลิกช่วงเวลานี้ใช่หรือไม่?", async () => {
                await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', id));
                render();
            });
        };

        window.clearByDay = (d) => window.uiConfirm("ลบข้อมูลรายวัน", `ต้องการลบข้อมูลของวันที่ ${formatDateTH(d)}?`, async () => {
            for(const b of window.state.bookings.filter(x => x.date === d)) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
        });
        window.clearAllHistory = () => window.uiConfirm("ล้างฐานข้อมูล", "ต้องการลบข้อมูลทั้งหมดหรือไม่?", async () => {
            for(const b of window.state.bookings) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
        });

        window.openQRModal = (id, name) => { window.state.showQRModal = { id, name }; render(); };
        window.closeQRModal = () => { window.state.showQRModal = null; render(); };

        const isServiceAvailable = (dateStr) => {
            const d = new Date(dateStr);
            const isInRange = (!window.state.settings.startDate || dateStr >= window.state.settings.startDate) &&
                              (!window.state.settings.endDate || dateStr <= window.state.settings.endDate);
            return isInRange && window.state.settings.availableDays.includes(d.getDay());
        };

        // --- Render Engine ---
        function render() {
            const app = document.getElementById('app');
            if (window.state.view === 'public_calendar' || window.state.view === 'public_slots') {
                app.innerHTML = renderPublicView();
            } else if (!window.state.isLoggedIn) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderHeader()}
                    <div class="scrollable-content custom-scrollbar">
                        <main class="max-w-xl mx-auto px-4 py-6">
                            ${window.state.isAdmin ? renderAdminUI() : renderUserUI()}
                        </main>
                    </div>
                    ${renderFooter()}
                    ${renderUIModal()}
                    ${renderQRModalDisplay()}
                    ${renderStickyAction()}
                `;
            }
            lucide.createIcons();
            if (window.state.view === 'scanner') setTimeout(window.initScanner, 100);
        }

        // --- View Templates ---
        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50">
                    <div class="max-w-sm w-full bg-white rounded-[2.5rem] p-10 shadow-2xl border border-white text-center page-transition">
                        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl"><i data-lucide="shield-check" size="40"></i></div>
                        <h1 class="text-3xl font-black text-slate-800 mb-2">SmartBooking</h1>
                        <p class="text-slate-400 text-[10px] font-bold uppercase mt-2 tracking-widest opacity-60">Identity & Access Management</p>
                        <form onsubmit="window.handleLogin(event)" class="mt-12 space-y-5">
                            <input id="login_sid" type="text" placeholder="รหัสนักศึกษา" class="w-full p-5 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-lg text-center outline-none focus:border-indigo-500 shadow-inner" required>
                            <button type="submit" class="w-full py-5 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all text-lg border-b-4 border-indigo-900">เข้าสู่ระบบ</button>
                        </form>
                        <div class="mt-8 pt-8 border-t border-slate-100">
                            <button onclick="window.state.view='public_calendar'; window.render();" class="flex items-center justify-center gap-2 mx-auto text-indigo-600 font-bold text-sm hover:underline active:scale-95 transition-all">
                                <i data-lucide="calendar-search" size="18"></i> ดูตารางการใช้งานรวม
                            </button>
                        </div>
                    </div>
                </div>
                ${renderUIModal()}
            `;
        }

        function renderPublicView() {
            if (window.state.view === 'public_slots') return renderPublicSlots();
            return renderPublicCalendar();
        }

        function renderPublicCalendar() {
            const date = window.state.calendarViewDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let daysHtml = [];
            for(let i=0; i<firstDay; i++) daysHtml.push('<div class="aspect-square"></div>');
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const available = isServiceAvailable(dateStr);
                // Filter by selected resource
                const count = window.state.bookings.filter(b => b.date === dateStr && b.resourceId === window.state.publicSelectedResourceId).length;
                daysHtml.push(`
                    <button onclick="${available ? `window.state.selectedDate='${dateStr}'; window.state.view='public_slots'; window.render();` : ''}" 
                            class="aspect-square flex flex-col items-center justify-center rounded-xl transition-all border-2 
                            ${available ? 'bg-white border-slate-50 hover:border-indigo-400 active:scale-90 shadow-sm' : 'bg-slate-50 border-transparent text-slate-300 cursor-not-allowed'}">
                        <span class="text-sm font-bold ${available ? 'text-slate-800' : ''}">${d}</span>
                        ${available && count > 0 ? `<div class="mt-1 w-1.5 h-1.5 bg-indigo-500 rounded-full"></div>` : ''}
                    </button>
                `);
            }

            return `
                <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden page-transition">
                    <header class="p-6 bg-white border-b border-slate-200 flex items-center justify-between">
                        <button onclick="window.state.view='login'; window.render();" class="p-3 bg-slate-100 rounded-xl active:scale-90"><i data-lucide="chevron-left"></i></button>
                        <h2 class="font-black text-slate-800 text-lg uppercase tracking-tight">ตารางการใช้งานรวม</h2>
                        <div class="w-10"></div>
                    </header>
                    <div class="scrollable-content p-6">
                        <div class="max-w-md mx-auto bg-white rounded-[2.5rem] p-8 shadow-xl border border-white">
                            
                            <!-- Resource Selector (If multiple) -->
                            ${window.state.resources.length > 1 ? `
                                <div class="mb-8 p-1 bg-slate-50 rounded-2xl border border-slate-100 flex gap-1">
                                    ${window.state.resources.map(r => `
                                        <button onclick="window.state.publicSelectedResourceId='${r.id}'; window.render();" 
                                                class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${window.state.publicSelectedResourceId === r.id ? 'bg-white text-indigo-600 shadow-sm border border-slate-100' : 'text-slate-400'}">
                                            ${r.name}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <div class="flex items-center justify-between mb-8 px-2">
                                <button onclick="window.state.calendarViewDate.setMonth(window.state.calendarViewDate.getMonth()-1); window.render();" class="p-2 hover:bg-slate-100 rounded-lg text-indigo-600"><i data-lucide="chevron-left" size="24"></i></button>
                                <div class="text-center">
                                    <h3 class="font-black text-slate-800 text-xl leading-none">${MONTHS_TH[month]}</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mt-2 tracking-widest">${year + 543}</p>
                                </div>
                                <button onclick="window.state.calendarViewDate.setMonth(window.state.calendarViewDate.getMonth()+1); window.render();" class="p-2 hover:bg-slate-100 rounded-lg text-indigo-600"><i data-lucide="chevron-right" size="24"></i></button>
                            </div>
                            <div class="calendar-grid mb-4">
                                ${DAYS_TH.map(d => `<div class="text-center text-[10px] font-black text-slate-400 uppercase py-2">${d.substring(0,2)}</div>`).join('')}
                                ${daysHtml.join('')}
                            </div>
                            <div class="mt-8 space-y-3 pt-6 border-t border-slate-50">
                                <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest text-center mb-4">สถานะปัจจุบัน: ${window.state.resources.find(r => r.id === window.state.publicSelectedResourceId)?.name || 'กำลังเลือก'}</p>
                                <div class="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                                    <div class="w-4 h-4 bg-white border-2 border-indigo-400 rounded-md"></div>
                                    <span>วันที่เปิดให้บริการ (คลิกเพื่อจอง)</span>
                                </div>
                                <div class="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                                    <div class="w-4 h-4 bg-slate-100 rounded-md"></div>
                                    <span>ปิดให้บริการ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPublicSlots() {
            const dateStr = window.state.selectedDate;
            const hStart = window.state.settings.startTime;
            const hEnd = window.state.settings.endTime;
            const slots = [];
            let current = new Date(`2000-01-01T${hStart}`);
            let endLimit = new Date(`2000-01-01T${hEnd}`);
            while (current < endLimit) {
                let sStart = current.toTimeString().substring(0, 5);
                let next = new Date(current.getTime() + 60 * 60 * 1000);
                if (next > endLimit) next = endLimit;
                slots.push({ start: sStart, end: next.toTimeString().substring(0, 5) });
                current.setHours(current.getHours() + 1);
            }

            // Only show the selected resource or all if none selected
            const resourceToShow = window.state.resources.filter(r => r.id === window.state.publicSelectedResourceId);

            return `
                <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden page-transition text-left">
                    <header class="p-6 bg-white border-b border-slate-200 flex items-center justify-between">
                        <button onclick="window.state.view='public_calendar'; window.render();" class="p-3 bg-slate-100 rounded-xl active:scale-90"><i data-lucide="chevron-left"></i></button>
                        <h2 class="font-black text-slate-800 text-lg">วันที่ ${formatDateTH(dateStr)}</h2>
                        <div class="w-10"></div>
                    </header>
                    <div class="scrollable-content p-4 space-y-4">
                        ${resourceToShow.map(res => {
                            const resBookings = window.state.bookings.filter(b => b.date === dateStr && b.resourceId === res.id);
                            return `
                                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 overflow-hidden">
                                    <div class="flex items-center gap-3 mb-6">
                                        <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center text-center"><i data-lucide="box" size="20"></i></div>
                                        <h3 class="font-black text-slate-800">${res.name}</h3>
                                    </div>
                                    <div class="space-y-3">
                                        ${slots.map(s => {
                                            const b = resBookings.find(x => x.slot === s.start);
                                            if (b) {
                                                return `
                                                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 flex justify-between items-center group">
                                                        <div class="text-left">
                                                            <p class="text-sm font-black text-slate-800 leading-none">${s.start} - ${s.end}</p>
                                                            <p class="text-[10px] font-bold text-red-500 uppercase mt-2 tracking-widest">จองโดย: ${b.studentId}</p>
                                                            <p class="text-[8px] text-slate-400 font-medium mt-1 uppercase">จองเมื่อ: ${formatDateTime(b.createdAt)}</p>
                                                        </div>
                                                        <div class="w-10 h-10 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-center"><i data-lucide="user-x" size="18"></i></div>
                                                    </div>
                                                `;
                                            } else {
                                                return `
                                                    <button onclick="window.uiConfirm('ต้องการจองเวลานี้?', 'ช่วงเวลานี้ว่าง! ต้องการเข้าสู่ระบบเพื่อทำการจองใช่หรือไม่?', () => { window.state.view='login'; window.render(); })" 
                                                            class="w-full p-4 bg-white rounded-2xl border-2 border-dashed border-slate-200 flex justify-between items-center hover:border-indigo-400 active:scale-95 transition-all group">
                                                        <div class="text-left">
                                                            <p class="text-sm font-black text-slate-400 group-hover:text-indigo-600 leading-none">${s.start} - ${s.end}</p>
                                                            <p class="text-[9px] font-bold text-green-500 uppercase mt-2 tracking-widest">ว่าง (คลิกเพื่อจอง)</p>
                                                        </div>
                                                        <div class="w-10 h-10 bg-slate-50 text-slate-300 group-hover:bg-indigo-50 group-hover:text-indigo-600 rounded-full flex items-center justify-center transition-all text-center"><i data-lucide="plus" size="18"></i></div>
                                                    </button>
                                                `;
                                            }
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ${renderUIModal()}
            `;
        }

        function renderAdminUI() {
            const activeDates = [...new Set(window.state.bookings.map(b => b.date))].sort();
            return `
                <div class="space-y-8 page-transition pb-32 text-left">
                    <!-- Whitelist Section -->
                    <section class="bg-slate-900 p-8 rounded-[2.5rem] shadow-xl space-y-6 text-left">
                        <h2 class="text-xl font-black text-white flex items-center gap-3"><i data-lucide="users-round" class="text-indigo-400"></i> Student Whitelist</h2>
                        <p class="text-indigo-300 text-[10px] font-bold uppercase tracking-widest opacity-70">วางรายชื่อที่ Copy จาก Excel ได้เลย (ระบบจะแยกให้อัตโนมัติ)</p>
                        <form onsubmit="window.saveWhitelist(event)" class="space-y-4">
                            <textarea name="studentsList" placeholder="วางรหัสนักศึกษาที่นี่..." class="w-full h-40 p-5 rounded-2xl bg-white/5 border-2 border-white/10 text-white font-mono text-xs outline-none focus:border-indigo-500 transition-all custom-scrollbar">${window.state.allowedStudents.join('\n')}</textarea>
                            <button type="submit" class="w-full py-5 bg-indigo-500 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-600 active:scale-95 transition-all text-xs uppercase tracking-widest border-b-4 border-indigo-800">อัปเดตรายชื่อ (${window.state.allowedStudents.length} รายการ)</button>
                        </form>
                    </section>

                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-8 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3"><i data-lucide="settings-2" class="text-indigo-600"></i> Project Settings</h2>
                        <form onsubmit="window.saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2 space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Project Name</label><input name="projectName" type="text" value="${window.state.settings.projectName}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold outline-none focus:border-indigo-500 shadow-inner" required></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Start Date</label><input name="startDate" type="date" value="${window.state.settings.startDate}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm text-center"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">End Date</label><input name="endDate" type="date" value="${window.state.settings.endDate}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm text-center"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Open</label><input name="startTime" type="time" value="${window.state.settings.startTime}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-center"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Close</label><input name="endTime" type="time" value="${window.state.settings.endTime}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-center"></div>
                            <div class="md:col-span-2 space-y-3"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Service Days</label><div class="flex flex-wrap gap-2">${DAYS_TH.map((d, i) => `<label class="flex items-center gap-3 bg-slate-50 px-4 py-3 rounded-2xl border-2 border-slate-100 text-[10px] font-bold cursor-pointer hover:bg-indigo-50 text-center text-left"><input type="checkbox" name="day-${i}" ${window.state.settings.availableDays.includes(i) ? 'checked' : ''} class="w-5 h-5 rounded text-indigo-600"> <span>${d}</span></label>`).join('')}</div></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Limit/Day (Hr)</label><input name="maxHoursDay" type="number" value="${window.state.settings.maxHoursPerDay}" class="w-full p-4 rounded-2xl bg-indigo-50 border-2 border-indigo-100 font-black text-indigo-600"></div>
                            <div class="space-y-2"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3">Total Limit (Hr)</label><input name="maxHoursTotal" type="number" value="${window.state.settings.maxTotalHours}" class="w-full p-4 rounded-2xl bg-indigo-50 border-2 border-indigo-100 font-black text-indigo-600"></div>
                            <button type="submit" class="md:col-span-2 py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all uppercase text-xs tracking-widest border-b-8 border-indigo-900 mt-4 text-center">บันทึกข้อมูลโครงสร้าง</button>
                        </form>
                    </section>
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3"><i data-lucide="box" class="text-indigo-600"></i> Manage Resources</h2>
                        <form onsubmit="window.addRes(event)" class="flex gap-3"><input name="resName" placeholder="ระบุชื่อจุดใช้งาน..." class="flex-1 p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm outline-none shadow-inner" required><button type="submit" class="px-8 bg-slate-900 text-white font-bold rounded-2xl text-[10px] uppercase shadow-lg text-center">เพิ่ม</button></form>
                        <div class="grid grid-cols-1 gap-3">${window.state.resources.map(res => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100"><div class="flex items-center gap-4"><div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-300 border border-slate-100 text-center"><i data-lucide="box" size="20"></i></div><div class="text-left"><p class="font-black text-slate-800 text-sm leading-none">${res.name}</p><p class="text-[8px] text-slate-400 font-bold uppercase mt-1.5">UID: ${res.id}</p></div></div><div class="flex gap-2"><button onclick="window.openQRModal('${res.id}', '${res.name}')" class="p-3 bg-white text-indigo-600 rounded-xl shadow-md border border-slate-100 active:scale-90 text-center"><i data-lucide="qr-code" size="18"></i></button><button onclick="window.deleteResource('${res.id}')" class="p-3 bg-white text-red-400 rounded-xl shadow-md border border-slate-100 active:scale-90 text-center"><i data-lucide="trash-2" size="18"></i></button></div></div>`).join('')}</div>
                    </section>
                </div>
            `;
        }

        function renderStickyAction() {
            if (window.state.view === 'calendar' && window.state.selectedSlots.length > 0) {
                return `
                    <div class="fixed bottom-24 left-0 right-0 px-6 z-40 max-w-xl mx-auto animate-in slide-in-from-bottom-20 flex flex-col items-center">
                        <button onclick="window.confirmBookingAction()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-[2.5rem] shadow-2xl transition-all active:scale-95 text-lg flex items-center justify-center gap-4 border-b-8 border-indigo-900 hover:brightness-110 text-center">
                            <i data-lucide="lock-keyhole" size="24"></i>
                            ยืนยันจอง ${window.state.selectedSlots.length} ช่วงเวลา
                        </button>
                    </div>
                `;
            }
            return "";
        }

        function renderFooter() {
            return `
                <footer class="flex-none bg-white border-t border-slate-100 py-6 px-8 z-50 shadow-inner">
                    <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">
                        <div class="flex items-center gap-4 border-r pr-8 border-slate-100 text-left">
                            <div class="w-10 h-10 rounded-2xl bg-slate-50 flex items-center justify-center text-indigo-400 shadow-inner text-center"><i data-lucide="fingerprint" size="18"></i></div>
                            <div class="text-left"><p class="text-[7px] opacity-40 mb-1 leading-none uppercase">Current User Session</p><p class="text-slate-800 leading-none font-black text-xs uppercase">${window.state.studentId || 'Not Logged In'}</p></div>
                        </div>
                        <div class="flex items-center gap-3 text-green-500 bg-green-50/50 px-5 py-2.5 rounded-xl border border-green-100 text-center">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#4ade80] text-center"></div> 
                            <span class="font-black text-[9px] uppercase">Cloud Service</span>
                        </div>
                    </div>
                </footer>
            `;
        }

        function renderQRModalDisplay() {
            if (!window.state.showQRModal) return "";
            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[200] flex items-center justify-center p-6 page-transition">
                    <div class="bg-white rounded-[3rem] p-10 max-w-sm w-full text-center relative shadow-2xl animate-in zoom-in duration-300 border-t-8 border-indigo-600">
                        <button onclick="window.closeQRModal()" class="absolute -top-4 -right-4 w-12 h-12 bg-white text-slate-800 rounded-2xl shadow-xl flex items-center justify-center border-2 border-slate-50 active:scale-75 transition-transform text-center"><i data-lucide="x" size="24"></i></button>
                        <h3 class="text-2xl font-black mb-1 text-slate-800 tracking-tight uppercase">${window.state.showQRModal.name}</h3>
                        <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-10 leading-none opacity-60">Scan to Check-in</p>
                        <div class="bg-slate-50 p-8 rounded-[2.5rem] mb-10 flex items-center justify-center border-2 border-slate-100 shadow-inner text-center">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${window.state.showQRModal.id}" alt="QR" class="w-full h-auto rounded-3xl shadow-xl">
                        </div>
                        <button onclick="window.print()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-700 transition-all flex items-center justify-center gap-4 active:scale-95 text-xs uppercase tracking-widest text-center"><i data-lucide="printer" size="20"></i> พิมพ์คิวอาร์ติดตั้ง</button>
                    </div>
                </div>
            `;
        }

        function renderUIModal() {
            if (!window.state.modal.show) return "";
            const isConfirm = window.state.modal.type === 'confirm';
            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[300] flex items-center justify-center p-8 page-transition">
                    <div class="bg-white rounded-[2.5rem] p-10 max-w-sm w-full text-center shadow-2xl border border-white">
                        <div class="w-16 h-16 ${window.state.modal.type === 'error' ? 'bg-red-50 text-red-500' : window.state.modal.type === 'success' ? 'bg-green-50 text-green-500' : 'bg-indigo-50 text-indigo-600'} rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner text-center">
                            <i data-lucide="${window.state.modal.type === 'error' ? 'alert-octagon' : window.state.modal.type === 'success' ? 'check-circle' : isConfirm ? 'help-circle' : 'info'}" size="32"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-800 mb-2 leading-tight">${window.state.modal.title}</h3>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed whitespace-pre-line">${window.state.modal.message}</p>
                        <div class="mt-8 flex gap-3">
                            ${isConfirm ? `
                                <button onclick="window.closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-500 font-bold rounded-2xl text-center">ยกเลิก</button>
                                <button onclick="window.state.modal.onConfirm(); window.closeModal();" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg border-b-4 border-indigo-900 text-center">ยืนยัน</button>
                            ` : `
                                <button onclick="window.closeModal()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg text-center">รับทราบ</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        init();

        window.setView = setView;
        window.initScanner = initScanner;
        window.processCheckIn = processCheckIn;
        window.handleLogin = handleLogin;
        window.logout = logout;
        window.selectResource = selectResource;
        window.toggleSlotSelection = toggleSlotSelection;
        window.confirmBookingAction = confirmBookingAction;
        window.viewPass = viewPass;
        window.saveSettings = saveSettings;
        window.saveWhitelist = saveWhitelist;
        window.addRes = addRes;
        window.deleteResource = deleteResource;
        window.delBooking = delBooking;
        window.clearByDay = clearByDay;
        window.clearAllHistory = clearAllHistory;
        window.openQRModal = openQRModal;
        window.closeQRModal = closeQRModal;
        window.closeModal = closeModal;
    </script>
</body>
</html>
