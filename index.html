<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartBooking - ระบบจองใช้งานทรัพยากร</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Prompt', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; overflow: hidden; height: 100vh; background-color: #f8fafc; margin:0; padding:0; }
        #app { height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 160px; 
        }

        @keyframes scan-line {
            0% { top: 15%; }
            100% { top: 85%; }
        }
        .animate-scan-line { animation: scan-line 2s linear infinite; }
        
        #reader { width: 100% !important; border: none !important; }
        #reader video { border-radius: 1rem; object-fit: cover; }
        
        .ticket-cutout {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), 
                              radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .page-transition { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-900">

    <div id="app">
        <div class="flex items-center justify-center h-full text-indigo-600">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-indigo-600 border-opacity-30"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAYWIoMwtHmhhcEGloHX2pjX_wmv9Wj-O0",
            authDomain: "picture-30ba8.firebaseapp.com",
            databaseURL: "https://picture-30ba8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "picture-30ba8",
            storageBucket: "picture-30ba8.firebasestorage.app",
            messagingSenderId: "486821075004",
            appId: "1:486821075004:web:ac910ff60949174c090b39",
            measurementId: "G-W0KL32TSHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbId = "smart-booking-v4"; 

        window.state = {
            user: null,
            studentId: localStorage.getItem('student_id') || '',
            isLoggedIn: !!localStorage.getItem('student_id'),
            isAdmin: localStorage.getItem('is_admin') === 'true',
            settings: { 
                projectName: "Global Access Project",
                maxHoursPerDay: 2,
                maxTotalHours: 10,
                startTime: "09:00", 
                endTime: "18:00", 
                availableDays: [1, 2, 3, 4, 5], 
                startDate: new Date().toISOString().split('T')[0], 
                endDate: "" 
            },
            resources: [],
            bookings: [],
            selectedResource: null,
            selectedDate: new Date().toISOString().split('T')[0],
            selectedSlots: [], 
            view: 'selection',
            activeBookings: [],
            modal: { show: false, title: '', message: '', type: 'info', onConfirm: null },
            showQRModal: null,
            isScanning: false
        };

        const DAYS_TH = ["อาทิตย์", "จันทร์", "อังคาร", "พุธ", "พฤหัสบดี", "ศุกร์", "เสาร์"];

        // --- Logic: Date/Time Utilities ---
        function addMinutes(time, mins) {
            let [h, m] = time.split(':').map(Number);
            let date = new Date(2000, 0, 1, h, m + mins);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        // แปลง YYYY-MM-DD เป็น DD-MM-YYYY
        function formatDateTH(dateStr) {
            if (!dateStr) return "-";
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        window.formatBookingRanges = (bookingList) => {
            if (!bookingList || bookingList.length === 0) return "ไม่มีข้อมูลเวลา";
            const sorted = [...bookingList].sort((a, b) => a.slot.localeCompare(b.slot));
            let ranges = [];
            if (sorted.length > 0) {
                let start = sorted[0].slot;
                let currentEnd = sorted[0].slot_end || addMinutes(start, 59);
                for (let i = 1; i < sorted.length; i++) {
                    if (sorted[i].slot === currentEnd || sorted[i].slot === addMinutes(currentEnd, 1)) {
                        currentEnd = sorted[i].slot_end || addMinutes(sorted[i].slot, 59);
                    } else {
                        ranges.push(`${start} - ${currentEnd}`);
                        start = sorted[i].slot;
                        currentEnd = sorted[i].slot_end || addMinutes(start, 59);
                    }
                }
                ranges.push(`${start} - ${currentEnd}`);
            }
            return ranges.join(", ");
        };

        // --- Firebase Core ---
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    window.state.user = u;
                    if (u) listenToData();
                });
            } catch (err) { window.uiAlert("Firebase Error: " + err.message, "error"); }
        }

        function listenToData() {
            onSnapshot(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), (s) => {
                if (s.exists()) window.state.settings = s.data();
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), (s) => {
                window.state.resources = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
            onSnapshot(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), (s) => {
                window.state.bookings = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        // --- UI Modal Logic ---
        window.uiAlert = (message, type = 'info') => {
            window.state.modal = { show: true, title: type === 'error' ? 'ข้อผิดพลาด' : 'แจ้งเตือน', message, type, onConfirm: null };
            render();
        };

        window.uiConfirm = (title, message, onConfirm) => {
            window.state.modal = { show: true, title, message, type: 'confirm', onConfirm };
            render();
        };

        window.closeModal = () => { window.state.modal.show = false; render(); };

        // --- Actions ---
        window.render = render;
        window.setView = (v) => { 
            window.state.view = v; 
            if (v !== 'scanner' && window.html5QrScanner) {
                window.html5QrScanner.clear();
                window.html5QrScanner = null;
                window.state.isScanning = false;
            }
            render(); 
        };

        window.handleLogin = (e) => {
            e.preventDefault();
            const input = document.getElementById('login_sid').value.trim();
            if (input === "Admin123") {
                window.state.isAdmin = true;
                window.state.isLoggedIn = true;
                window.state.studentId = "ADMIN";
                localStorage.setItem('is_admin', 'true');
            } else if (input.length >= 5) {
                window.state.isAdmin = false;
                window.state.isLoggedIn = true;
                window.state.studentId = input;
                localStorage.setItem('student_id', input);
                localStorage.setItem('is_admin', 'false');
            } else { return window.uiAlert("กรุณาระบุข้อมูลที่ถูกต้อง", "error"); }
            render();
        };

        window.logout = () => { 
            window.uiConfirm("ออกจากระบบ", "คุณต้องการออกจากระบบใช่หรือไม่?", () => {
                localStorage.clear();
                window.state.isLoggedIn = false; 
                window.state.isAdmin = false;
                window.state.view = 'selection';
                render();
            });
        };

        window.selectResource = (id, name) => { 
            window.state.selectedResource = { id, name }; 
            window.state.selectedSlots = [];
            window.state.view = 'calendar'; 
            render(); 
        };

        window.toggleSlotSelection = (slotObj) => {
            const index = window.state.selectedSlots.findIndex(s => s.start === slotObj.start);
            if (index > -1) {
                window.state.selectedSlots.splice(index, 1);
            } else {
                const dailyBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
                if (dailyBooked + window.state.selectedSlots.length >= window.state.settings.maxHoursPerDay) {
                    return window.uiAlert(`เกินโควตาต่อวัน! (${window.state.settings.maxHoursPerDay} ชม./วัน)`, "error");
                }
                const totalBooked = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;
                if (totalBooked + window.state.selectedSlots.length >= window.state.settings.maxTotalHours) {
                    return window.uiAlert(`เกินโควตาทั้งหมด! (${window.state.settings.maxTotalHours} ชม. ต่อโปรเจกต์)`, "error");
                }
                window.state.selectedSlots.push(slotObj);
            }
            render();
        };

        window.confirmBookingAction = async () => {
            if (window.state.selectedSlots.length === 0) return;
            try {
                const newItems = [];
                for (const slotObj of window.state.selectedSlots) {
                    const data = {
                        resourceId: window.state.selectedResource.id,
                        resourceName: window.state.selectedResource.name,
                        date: window.state.selectedDate,
                        slot: slotObj.start,
                        slot_end: slotObj.end,
                        studentId: window.state.studentId,
                        status: 'booked',
                        createdAt: serverTimestamp()
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'bookings'), data);
                    newItems.push({ id: docRef.id, ...data });
                }
                window.state.activeBookings = newItems;
                window.state.selectedSlots = [];
                window.state.view = 'pass';
                render();
            } catch (err) { window.uiAlert("Booking failed: " + err.message, "error"); }
        };

        window.viewPass = (list) => { window.state.activeBookings = list; window.state.view = 'pass'; render(); };

        window.initScanner = () => {
            if (window.state.isScanning) return;
            window.state.isScanning = true;
            window.html5QrScanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
            window.html5QrScanner.render((text) => {
                const targetId = window.state.activeBookings[0]?.resourceId;
                if (text === targetId) {
                    window.html5QrScanner.clear().then(() => {
                        window.state.isScanning = false;
                        window.processCheckIn(targetId);
                    });
                } else { window.uiAlert("รหัสคิวอาร์ไม่ตรงกับเครื่องที่จองไว้", "error"); }
            }, () => {});
        };

        window.processCheckIn = async (resId) => {
            for (const b of window.state.activeBookings) {
                await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id), { status: 'checked_in', checkInAt: new Date().toISOString() });
            }
            await updateDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', resId), { status: 'in_use', currentStudent: window.state.studentId, startedAt: new Date().toISOString() });
            window.state.view = 'selection';
            window.state.activeBookings = [];
            window.uiAlert("เช็คอินสำเร็จ! ยินดีต้อนรับ");
        };

        window.saveSettings = async (e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const days = DAYS_TH.map((_, i) => f.get(`day-${i}`) ? i : null).filter(x => x !== null);
            await setDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'settings', 'global_config'), {
                projectName: f.get('projectName'),
                maxHoursPerDay: parseInt(f.get('maxHoursDay')),
                maxTotalHours: parseInt(f.get('maxHoursTotal')),
                startTime: f.get('startTime'),
                endTime: f.get('endTime'),
                startDate: f.get('startDate'),
                endDate: f.get('endDate'),
                availableDays: days
            });
            window.uiAlert("บันทึกการตั้งค่าเรียบร้อยแล้ว");
        };

        window.addRes = async (e) => {
            e.preventDefault();
            const name = e.target.resName.value.trim();
            if (name) await addDoc(collection(db, 'artifacts', fbId, 'public', 'data', 'resources'), { name, status: 'idle' });
            e.target.reset();
        };

        window.deleteResource = (id) => window.uiConfirm("ลบทรัพยากร", "คุณต้องการลบรายการนี้ใช่หรือไม่?", async () => await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'resources', id)));
        window.delBooking = (id) => window.uiConfirm("ยกเลิกการจอง", "คุณต้องการยกเลิกช่วงเวลานี้ใช่หรือไม่?", async () => await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', id)));
        window.clearByDay = (d) => window.uiConfirm("ลบข้อมูลรายวัน", `ต้องการลบข้อมูลทั้งหมดของวันที่ ${formatDateTH(d)}?`, async () => {
            for(const b of window.state.bookings.filter(x => x.date === d)) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
        });
        window.clearAllHistory = () => window.uiConfirm("ล้างฐานข้อมูล", "ต้องการลบข้อมูลการจองทั้งหมดหรือไม่?", async () => {
            for(const b of window.state.bookings) await deleteDoc(doc(db, 'artifacts', fbId, 'public', 'data', 'bookings', b.id));
        });

        window.openQRModal = (id, name) => { window.state.showQRModal = { id, name }; render(); };
        window.closeQRModal = () => { window.state.showQRModal = null; render(); };

        const isServiceAvailable = () => {
            const d = new Date(window.state.selectedDate);
            const isInRange = (!window.state.settings.startDate || window.state.selectedDate >= window.state.settings.startDate) &&
                              (!window.state.settings.endDate || window.state.selectedDate <= window.state.settings.endDate);
            return isInRange && window.state.settings.availableDays.includes(d.getDay());
        };

        // --- Render Engine ---
        function render() {
            const app = document.getElementById('app');
            const scrollEl = document.querySelector('.scrollable-content');
            const scrollPos = scrollEl ? scrollEl.scrollTop : 0;

            if (!window.state.isLoggedIn) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = `
                    ${renderHeader()}
                    <div class="scrollable-content custom-scrollbar">
                        <main class="max-w-xl mx-auto px-4 py-6">
                            ${window.state.isAdmin ? renderAdminUI() : renderUserUI()}
                        </main>
                    </div>
                    ${renderFooter()}
                    ${renderUIModal()}
                    ${renderQRModalDisplay()}
                    ${renderStickyAction()}
                `;
            }
            lucide.createIcons();
            
            const newScrollEl = document.querySelector('.scrollable-content');
            if (newScrollEl) newScrollEl.scrollTop = scrollPos;

            if (window.state.view === 'scanner') setTimeout(window.initScanner, 100);
        }

        // --- View Templates ---
        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-6 bg-slate-50 text-center">
                    <div class="max-w-sm w-full bg-white rounded-[2.5rem] p-10 shadow-2xl border border-white text-center page-transition text-center">
                        <div class="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl text-center"><i data-lucide="shield-check" size="40"></i></div>
                        <h1 class="text-3xl font-black text-slate-800 mb-2 leading-none text-center">SmartBooking</h1>
                        <p class="text-slate-400 text-[10px] font-bold uppercase mt-2 tracking-widest opacity-60 text-center">Authentication Portal</p>
                        <form onsubmit="handleLogin(event)" class="mt-12 space-y-5 text-center">
                            <input id="login_sid" type="text" placeholder="รหัสนักศึกษา" class="w-full p-5 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-lg text-center outline-none focus:border-indigo-500 shadow-inner text-center" required>
                            <button type="submit" class="w-full py-5 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all text-lg border-b-4 border-indigo-900 text-center">เข้าสู่ระบบ</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <header class="bg-white border-b border-slate-100 flex-none h-16 px-6 z-50 shadow-sm">
                    <div class="max-w-2xl mx-auto h-full flex items-center justify-between text-left">
                        <div class="flex items-center gap-3 cursor-pointer text-left" onclick="setView('selection'); window.state.selectedResource=null; render();">
                            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg text-center"><i data-lucide="layers" size="20"></i></div>
                            <div class="text-left">
                                <h1 class="font-black text-base leading-none text-slate-800 uppercase text-left">Smart</h1>
                                <p class="text-[8px] font-bold text-indigo-600 uppercase tracking-widest mt-1 truncate max-w-[100px] text-left">${window.state.settings.projectName}</p>
                            </div>
                        </div>
                        <button onclick="logout()" class="p-3 bg-slate-50 text-slate-400 hover:text-red-500 rounded-xl border border-slate-100 active:scale-90 transition-all text-center"><i data-lucide="power" size="18"></i></button>
                    </div>
                </header>
            `;
        }

        function renderUserUI() {
            if (window.state.view === 'scanner') return renderScannerUI();
            if (window.state.view === 'pass') return renderReceiptUI();
            if (!window.state.selectedResource) return renderResourceMenu();
            return renderCalendarUI();
        }

        function renderResourceMenu() {
            const startDateTH = formatDateTH(window.state.settings.startDate);
            const endDateTH = formatDateTH(window.state.settings.endDate);
            const dateRangeText = (window.state.settings.startDate && window.state.settings.endDate) 
                ? `${startDateTH} ถึง ${endDateTH}`
                : window.state.settings.startDate ? `ตั้งแต่ ${startDateTH}` : 'เปิดให้บริการถาวร';

            return `
                <div class="space-y-6 page-transition text-left">
                    <div class="bg-indigo-600 p-8 rounded-[2rem] text-white shadow-xl relative overflow-hidden text-left">
                        <p class="text-[9px] font-bold uppercase tracking-widest opacity-60 mb-2 text-left">Authenticated ID</p>
                        <h2 class="text-4xl font-black tracking-tighter leading-none text-left">${window.state.studentId}</h2>
                        <div class="flex items-center gap-2 text-indigo-200 text-[9px] font-bold mt-8 bg-white/10 w-fit px-4 py-1.5 rounded-full border border-white/10 uppercase tracking-widest text-left">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_10px_#4ade80] text-center"></div>
                            <span class="text-left text-left">Cloud Connected</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 text-left">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-2 leading-none text-left">เลือกทรัพยากรเพื่อดำเนินการจอง</div>
                        ${window.state.resources.map(res => `
                            <button onclick="selectResource('${res.id}', '${res.name}')" class="group bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-lg hover:border-indigo-200 transition-all text-left flex items-center justify-between active:scale-[0.99]">
                                <div class="flex items-center gap-5 text-left">
                                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${res.status === 'in_use' ? 'bg-orange-50 text-orange-500 shadow-inner' : 'bg-slate-50 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white'} text-center">
                                        <i data-lucide="map-pin" size="22"></i>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="font-bold text-base text-slate-800 leading-tight text-left">${res.name}</h3>
                                        
                                        <div class="space-y-1 mt-2 text-left">
                                            <div class="flex items-center gap-1.5 text-left opacity-50">
                                                <i data-lucide="calendar-range" size="10"></i>
                                                <span class="text-[9px] font-bold uppercase tracking-widest text-left">ช่วงวันที่: ${dateRangeText}</span>
                                            </div>
                                            <div class="flex items-center gap-1.5 text-left opacity-50">
                                                <i data-lucide="clock" size="10"></i>
                                                <span class="text-[9px] font-bold uppercase tracking-widest text-left">ช่วงเวลา: ${window.state.settings.startTime} - ${window.state.settings.endTime} น.</span>
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-2 mt-3 text-left">
                                            <div class="w-2 h-2 rounded-full ${res.status === 'in_use' ? 'bg-orange-400 animate-pulse' : 'bg-green-400'} text-center"></div>
                                            <span class="text-[9px] font-bold uppercase tracking-widest ${res.status === 'in_use' ? 'text-orange-500' : 'text-green-500'} text-left">
                                                ${res.status === 'in_use' ? `In Use by ${res.currentStudent}` : 'พร้อมใช้งาน'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" size="20" class="text-slate-200 group-hover:text-indigo-600 transition-all text-center"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCalendarUI() {
            const hStart = window.state.settings.startTime;
            const hEnd = window.state.settings.endTime;
            const slots = [];
            
            let current = new Date(`2000-01-01T${hStart}`);
            let endLimit = new Date(`2000-01-01T${hEnd}`);
            
            while (current < endLimit) {
                let sStart = current.toTimeString().substring(0, 5);
                let next = new Date(current.getTime() + 60 * 60 * 1000);
                if (next > endLimit) next = endLimit;
                let sEnd = next.toTimeString().substring(0, 5);
                slots.push({ start: sStart, end: sEnd });
                current.setHours(current.getHours() + 1);
            }
            
            const myToday = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate && b.resourceId === window.state.selectedResource.id);
            const bookedDaily = window.state.bookings.filter(b => b.studentId === window.state.studentId && b.date === window.state.selectedDate).length;
            const bookedTotal = window.state.bookings.filter(b => b.studentId === window.state.studentId).length;

            return `
                <div class="space-y-4 page-transition text-left">
                    <button onclick="setView('selection'); window.state.selectedResource=null; render();" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 text-[10px] font-bold uppercase tracking-widest active:scale-95 transition-all text-left"><i data-lucide="arrow-left" size="14"></i> เปลี่ยนจุดใช้งาน</button>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-xl space-y-6 text-left">
                        <div class="flex items-center gap-4 text-indigo-600 text-left">
                            <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center shadow-inner text-center"><i data-lucide="calendar" size="24"></i></div>
                            <div class="text-left">
                                <h2 class="text-xl font-black text-slate-800 text-left">${window.state.selectedResource.name}</h2>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1 text-left">Booking Timeline</p>
                            </div>
                        </div>
                        <input type="date" value="${window.state.selectedDate}" onchange="window.state.selectedDate=this.value; window.state.selectedSlots=[]; render();" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-slate-800 text-center outline-none focus:border-indigo-300 text-center">
                        <p class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest text-center">วันที่กำลังจอง: ${formatDateTH(window.state.selectedDate)}</p>
                        
                        ${!isServiceAvailable() ? `<div class="p-12 bg-orange-50 rounded-3xl text-center border-2 border-dashed border-orange-200 text-center text-center"><p class="font-bold text-orange-700 text-sm text-center">ไม่เปิดให้บริการในวันที่เลือก</p></div>` : `
                            <div class="grid grid-cols-2 gap-3 text-left">
                                <div class="bg-indigo-600 p-4 rounded-2xl text-white shadow-lg text-left">
                                    <p class="text-[8px] font-bold uppercase opacity-60 mb-1 leading-none text-left tracking-wider">โควตาวันนี้</p>
                                    <p class="text-2xl font-black leading-none text-left">${bookedDaily + window.state.selectedSlots.length} / ${window.state.settings.maxHoursPerDay} <span class="text-[10px] opacity-50 uppercase text-center">ชม.</span></p>
                                </div>
                                <div class="bg-slate-900 p-4 rounded-2xl text-white shadow-lg text-left">
                                    <p class="text-[8px] font-bold uppercase opacity-60 mb-1 leading-none text-left tracking-wider">โควตาทั้งหมด</p>
                                    <p class="text-2xl font-black leading-none text-left">${bookedTotal + window.state.selectedSlots.length} / ${window.state.settings.maxTotalHours} <span class="text-[10px] opacity-50 uppercase text-center">ชม.</span></p>
                                </div>
                            </div>

                            ${myToday.length > 0 ? `<button onclick='viewPass(${JSON.stringify(myToday).replace(/'/g, "&apos;").replace(/"/g, "&quot;")})' class="w-full p-4 bg-green-50 border-2 border-dashed border-green-200 text-green-700 rounded-2xl text-[10px] font-bold uppercase tracking-widest flex items-center justify-center gap-3 shadow-sm animate-pulse text-center"><i data-lucide="ticket" size="16"></i> ดูใบจองของคุณ</button>` : ''}
                            <div class="grid grid-cols-1 gap-2.5 text-left">
                                ${slots.map(s => {
                                    const bOthers = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === s.start && b.resourceId === window.state.selectedResource.id && b.studentId !== window.state.studentId);
                                    const bMine = window.state.bookings.find(b => b.date === window.state.selectedDate && b.slot === s.start && b.resourceId === window.state.selectedResource.id && b.studentId === window.state.studentId);
                                    const isSelecting = window.state.selectedSlots.some(sel => sel.start === s.start);
                                    
                                    let btnClass = "bg-white border-slate-100 text-slate-500 hover:border-indigo-300";
                                    let sText = "พร้อมจอง"; 
                                    let act = `toggleSlotSelection(${JSON.stringify(s).replace(/"/g, '&quot;')})`;
                                    if (bOthers) { btnClass = "bg-slate-50 border-slate-100 text-slate-300 opacity-50 cursor-not-allowed"; sText = `จองแล้ว ID:${bOthers.studentId.slice(-4)}`; act = ""; }
                                    else if (bMine) { btnClass = "bg-green-50 border-green-500 text-green-700 shadow-sm"; sText = "จองแล้ว (คลิกเพื่อยกเลิก)"; act = `delBooking('${bMine.id}')`; }
                                    else if (isSelecting) { btnClass = "bg-indigo-600 border-indigo-600 text-white shadow-xl ring-4 ring-indigo-50"; sText = "กำลังเลือก"; }
                                    
                                    return `<button onclick='${act}' class="relative p-5 rounded-2xl border-2 transition-all flex justify-between items-center ${btnClass} active:scale-[0.98] text-center text-left"><div class="text-left leading-none text-left"><span class="text-base font-bold text-left">${s.start} - ${s.end}</span><p class="text-[8px] font-bold uppercase mt-1.5 opacity-60 tracking-widest text-left">${sText}</p></div><div class="w-8 h-8 rounded-xl flex items-center justify-center ${bMine || isSelecting ? 'bg-white/20' : 'bg-slate-50'} shadow-inner text-center">${bMine || isSelecting ? '<i data-lucide="check" size="16"></i>' : '<i data-lucide="plus" size="16" class="opacity-20"></i>'}</div></button>`;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderReceiptUI() {
            const dateStr = window.state.activeBookings[0]?.date;
            const resName = window.state.activeBookings[0]?.resourceName;
            const timeText = window.formatBookingRanges(window.state.activeBookings);

            return `
                <div class="max-w-xs mx-auto animate-in zoom-in duration-300 page-transition text-center">
                    <div class="bg-white rounded-[2.5rem] overflow-hidden shadow-2xl border border-slate-100 relative text-center">
                        <div class="bg-indigo-600 p-8 text-white text-center">
                            <i data-lucide="ticket" size="40" class="mx-auto mb-4 opacity-40 text-center"></i>
                            <h2 class="text-2xl font-black mb-1 tracking-tight leading-none text-white text-center">ยืนยันการจอง</h2>
                            <p class="text-indigo-200 text-[8px] font-bold uppercase tracking-widest opacity-60 mt-1 text-center">Confirmed Pass</p>
                        </div>
                        <div class="p-8 space-y-5 ticket-cutout text-center">
                            <div class="pb-4 border-b border-slate-100 text-center"><p class="text-[8px] font-bold text-slate-400 uppercase mb-1 text-center">Resource</p><p class="text-xl font-black text-slate-800 leading-tight uppercase text-center">${resName}</p></div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="text-center"><p class="text-[8px] font-bold text-slate-400 uppercase mb-1 text-center">Student ID</p><p class="text-sm font-bold text-slate-800 text-center">${window.state.studentId}</p></div>
                                <div class="text-center"><p class="text-[8px] font-bold text-slate-400 uppercase mb-1 text-center">Date</p><p class="text-sm font-bold text-slate-800 text-center">${formatDateTH(dateStr)}</p></div>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border-2 border-dashed border-slate-200 text-center">
                                <p class="text-[8px] font-bold text-slate-400 uppercase mb-2 text-center">Approved Time Slots</p>
                                <p class="text-indigo-600 font-black text-base leading-tight text-center">${timeText}</p>
                            </div>
                            <div class="pt-4 flex flex-col gap-3 text-center">
                                <button onclick="setView('scanner')" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 text-center">
                                    <i data-lucide="qr-code" size="20"></i> สแกนเช็คอิน
                                </button>
                                <button onclick="setView('selection'); window.state.activeBookings=[]; render();" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest py-2 text-center">กลับหน้าหลัก</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScannerUI() {
            return `
                <div class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-8 text-white text-center">
                    <h2 class="text-3xl font-black mb-1 tracking-tight text-white text-center">เช็คอินเข้าใช้งาน</h2>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] opacity-70 mt-2 mb-12 text-center">Point at Resource QR</p>
                    <div class="relative w-full max-w-sm aspect-square bg-black rounded-[3rem] overflow-hidden border-8 border-white/5 shadow-2xl text-center">
                        <div id="reader" class="w-full h-full text-center"></div>
                        <div class="absolute inset-0 pointer-events-none border-[4rem] border-slate-900/60 z-10 shadow-inner text-center"></div>
                        <div class="absolute top-1/2 left-0 right-0 h-1.5 bg-indigo-500 shadow-[0_0_25px_#6366f1] animate-scan-line z-20 text-center"></div>
                    </div>
                    <div class="mt-12 space-y-4 w-full max-w-sm text-center">
                        <div class="bg-white/5 border border-white/10 p-5 rounded-2xl backdrop-blur-xl text-center">
                            <p class="text-[8px] font-bold uppercase tracking-widest text-indigo-400 mb-2 text-center">Target:</p>
                            <p class="font-black text-lg leading-none uppercase text-white text-center">${window.state.activeBookings[0]?.resourceName}</p>
                        </div>
                        <button onclick="setView('pass')" class="w-full py-5 bg-white/10 text-white font-bold rounded-2xl border border-white/10 text-[10px] uppercase tracking-widest text-center">ยกเลิกสแกน</button>
                    </div>
                </div>
            `;
        }

        function renderAdminUI() {
            const activeDates = [...new Set(window.state.bookings.map(b => b.date))].sort();
            return `
                <div class="space-y-8 page-transition pb-32 text-left">
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-8 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none"><i data-lucide="settings-2" class="text-indigo-600"></i> Project Settings</h2>
                        <form onsubmit="saveSettings(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                            <div class="md:col-span-2 space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Project Name</label><input name="projectName" type="text" value="${window.state.settings.projectName}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold outline-none focus:border-indigo-500 shadow-inner text-left" required></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Start Date</label><input name="startDate" type="date" value="${window.state.settings.startDate}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm text-center"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">End Date</label><input name="endDate" type="date" value="${window.state.settings.endDate}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm text-center"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Open</label><input name="startTime" type="time" value="${window.state.settings.startTime}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-center"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Close</label><input name="endTime" type="time" value="${window.state.settings.endTime}" class="w-full p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-center"></div>
                            <div class="md:col-span-2 space-y-3 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Service Days</label><div class="flex flex-wrap gap-2 text-left">${DAYS_TH.map((d, i) => `<label class="flex items-center gap-3 bg-slate-50 px-4 py-3 rounded-2xl border-2 border-slate-100 text-[10px] font-bold cursor-pointer hover:bg-indigo-50 text-center"><input type="checkbox" name="day-${i}" ${window.state.settings.availableDays.includes(i) ? 'checked' : ''} class="w-5 h-5 rounded text-indigo-600 text-center"> <span class="text-left">${d}</span></label>`).join('')}</div></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Limit/Day (Hr)</label><input name="maxHoursDay" type="number" value="${window.state.settings.maxHoursPerDay}" class="w-full p-4 rounded-2xl bg-indigo-50 border-2 border-indigo-100 font-black text-indigo-600 text-left"></div>
                            <div class="space-y-2 text-left"><label class="text-[10px] font-bold uppercase text-slate-400 ml-3 text-left">Total Limit (Hr)</label><input name="maxHoursTotal" type="number" value="${window.state.settings.maxTotalHours}" class="w-full p-4 rounded-2xl bg-indigo-50 border-2 border-indigo-100 font-black text-indigo-600 text-left"></div>
                            <button type="submit" class="md:col-span-2 py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-700 active:scale-95 transition-all uppercase text-xs tracking-widest border-b-8 border-indigo-900 mt-4 text-center">บันทึกโครงสร้างระบบ</button>
                        </form>
                    </section>
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left">
                        <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none"><i data-lucide="box" class="text-indigo-600"></i> Manage Resources</h2>
                        <form onsubmit="addRes(event)" class="flex gap-3 text-left"><input name="resName" placeholder="ระบุชื่อจุดใช้งาน..." class="flex-1 p-4 rounded-2xl bg-slate-50 border-2 border-slate-100 font-bold text-sm outline-none shadow-inner text-left" required><button type="submit" class="px-8 bg-slate-900 text-white font-bold rounded-2xl text-[10px] uppercase shadow-lg text-center">เพิ่ม</button></form>
                        <div class="grid grid-cols-1 gap-3 text-left">${window.state.resources.map(res => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100 text-left"><div class="flex items-center gap-4 text-left"><div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-300 border border-slate-100 text-center text-center"><i data-lucide="box" size="20"></i></div><div class="text-left"><p class="font-black text-slate-800 text-sm leading-none text-left">${res.name}</p><p class="text-[8px] text-slate-400 font-bold uppercase mt-1.5 text-left">UID: ${res.id}</p></div></div><div class="flex gap-2 text-left"><button onclick="openQRModal('${res.id}', '${res.name}')" class="p-3 bg-white text-indigo-600 rounded-xl shadow-md border border-slate-100 active:scale-90 transition-all text-center"><i data-lucide="qr-code" size="18"></i></button><button onclick="deleteResource('${res.id}')" class="p-3 bg-white text-red-400 rounded-xl shadow-md border border-slate-100 active:scale-90 transition-all text-center"><i data-lucide="trash-2" size="18"></i></button></div></div>`).join('')}</div>
                    </section>
                    <section class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-xl space-y-6 text-left overflow-hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 text-left leading-none">
                            <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 text-left leading-none text-left"> <i data-lucide="history" class="text-indigo-600"></i> History & Clearing</h2>
                            <button onclick="clearAllHistory()" class="px-5 py-2.5 bg-red-50 text-red-500 text-[10px] font-bold uppercase rounded-xl border border-red-100 hover:bg-red-100 text-center leading-none text-center">ล้างฐานข้อมูลทั้งหมด</button>
                        </div>
                        <div class="bg-slate-50 p-5 rounded-3xl space-y-3 text-left">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest text-left">ลบประวัติรายวันอัจฉริยะ (เลือกวันที่ต้องการลบ)</p>
                            <div class="flex flex-wrap gap-2 text-left">
                                ${activeDates.length > 0 ? activeDates.map(d => `<button onclick="clearByDay('${d}')" class="px-3 py-2 bg-white text-[10px] font-bold text-indigo-600 rounded-xl border border-indigo-100 shadow-sm hover:border-red-400 hover:text-red-500 transition-all active:scale-95 text-center flex items-center gap-2 text-center"><i data-lucide="calendar" size="12"></i> ${formatDateTH(d)}</button>`).join('') : '<p class="text-[10px] text-slate-300 font-bold text-left leading-none">ไม่มีประวัติการจองในระบบ</p>'}
                            </div>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar text-left"><table class="w-full text-left border-collapse text-left"><thead class="border-b border-slate-100 text-[9px] font-bold uppercase text-slate-400 text-left"><tr><th class="py-5 text-left">SCHEDULE</th><th class="py-5 text-left">IDENTIFIER</th><th class="py-5 text-center text-center">STATUS</th><th class="py-5 text-right"></th></tr></thead><tbody class="divide-y divide-slate-50 text-left">${window.state.bookings.slice().sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(b => `<tr class="group hover:bg-slate-50/50 text-left"><td class="py-5 text-left"><p class="font-black text-slate-800 text-[12px] text-left">${formatDateTH(b.date)}</p><p class="text-[9px] text-indigo-600 font-bold mt-1 uppercase text-left leading-none">${b.slot}-${b.slot_end?.split(':')[1] || '59'}</p></td><td class="py-5 text-left"><p class="text-slate-800 font-black text-[12px] truncate max-w-[100px] text-left leading-none">${b.studentId}</p><p class="text-[8px] text-slate-400 font-bold uppercase mt-1 truncate max-w-[100px] text-left leading-none">${b.resourceName}</p></td><td class="py-5 text-center">${b.status === 'checked_in' ? `<span class="px-2.5 py-1 bg-green-100 text-green-600 text-[8px] font-bold rounded-full uppercase border border-green-200 text-center">Arrived</span>` : `<span class="px-2.5 py-1 bg-slate-100 text-slate-400 text-[8px] font-bold rounded-full uppercase border border-slate-200 opacity-60 text-center">Wait</span>`}</td><td class="py-5 text-right"><button onclick="delBooking('${b.id}')" class="p-2 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all text-center"><i data-lucide="trash-2" size="18"></i></button></td></tr>`).join('')}</tbody></table></div>
                    </section>
                </div>
            `;
        }

        function renderStickyAction() {
            if (window.state.view === 'calendar' && window.state.selectedSlots.length > 0) {
                return `
                    <div class="fixed bottom-24 left-0 right-0 px-6 z-40 max-w-xl mx-auto animate-in slide-in-from-bottom-20 flex flex-col items-center text-center">
                        <button onclick="confirmBookingAction()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-[2.5rem] shadow-2xl transition-all active:scale-95 text-lg flex items-center justify-center gap-4 border-b-8 border-indigo-900 hover:brightness-110 text-center">
                            <i data-lucide="lock-keyhole" size="24"></i>
                            ยืนยันจอง ${window.state.selectedSlots.length} ช่วงเวลา
                        </button>
                    </div>
                `;
            }
            return "";
        }

        function renderFooter() {
            return `
                <footer class="flex-none bg-white border-t border-slate-100 py-6 px-8 z-50 shadow-inner">
                    <div class="max-w-2xl mx-auto flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">
                        <div class="flex items-center gap-4 border-r pr-8 border-slate-100 text-left">
                            <div class="w-10 h-10 rounded-2xl bg-slate-50 flex items-center justify-center text-indigo-400 shadow-inner text-center"><i data-lucide="fingerprint" size="18"></i></div>
                            <div class="text-left"><p class="text-[7px] opacity-40 mb-1 leading-none uppercase text-left">Session User</p><p class="text-slate-800 leading-none font-black text-xs uppercase text-left">${window.state.studentId || 'N/A'}</p></div>
                        </div>
                        <div class="flex items-center gap-3 text-green-500 bg-green-50/50 px-5 py-2.5 rounded-xl border border-green-100 text-center">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#4ade80] text-center"></div> 
                            <span class="font-black text-[9px] text-center">Live Sync</span>
                        </div>
                    </div>
                </footer>
            `;
        }

        function renderQRModalDisplay() {
            if (!window.state.showQRModal) return "";
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${window.state.showQRModal.id}`;
            return `
                <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[200] flex items-center justify-center p-6 page-transition text-center">
                    <div class="bg-white rounded-[3rem] p-10 max-w-sm w-full text-center relative shadow-2xl animate-in zoom-in duration-300 border-t-8 border-indigo-600 text-center">
                        <button onclick="closeQRModal()" class="absolute -top-4 -right-4 w-12 h-12 bg-white text-slate-800 rounded-2xl shadow-xl flex items-center justify-center border-2 border-slate-50 active:scale-75 transition-transform text-center"><i data-lucide="x" size="24"></i></button>
                        <h3 class="text-2xl font-black mb-1 text-slate-800 tracking-tight uppercase text-center">${window.state.showQRModal.name}</h3>
                        <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-10 leading-none opacity-60 text-center">Point Device Here to Check-In</p>
                        <div class="bg-slate-50 p-8 rounded-[2.5rem] mb-10 flex items-center justify-center border-2 border-slate-100 shadow-inner text-center">
                            <img src="${qrUrl}" alt="QR" class="w-full h-auto rounded-3xl shadow-xl text-center">
                        </div>
                        <button onclick="window.print()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl hover:bg-indigo-700 transition-all flex items-center justify-center gap-4 active:scale-95 text-xs uppercase tracking-widest text-center"><i data-lucide="printer" size="20"></i> พิมพ์รหัส QR สำหรับติดอุปกรณ์</button>
                    </div>
                </div>
            `;
        }

        function renderUIModal() {
            if (!window.state.modal.show) return "";
            const isConfirm = window.state.modal.type === 'confirm';
            return `
                <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[300] flex items-center justify-center p-8 page-transition text-center">
                    <div class="bg-white rounded-[2.5rem] p-10 max-w-sm w-full text-center shadow-2xl border border-white text-center">
                        <div class="w-16 h-16 ${window.state.modal.type === 'error' ? 'bg-red-50 text-red-500' : 'bg-indigo-50 text-indigo-600'} rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner text-center">
                            <i data-lucide="${window.state.modal.type === 'error' ? 'alert-octagon' : isConfirm ? 'help-circle' : 'info'}" size="32"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-800 mb-2 leading-tight text-center">${window.state.modal.title}</h3>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed text-center">${window.state.modal.message}</p>
                        <div class="mt-8 flex gap-3 text-center">
                            ${isConfirm ? `
                                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-500 font-bold rounded-2xl hover:bg-slate-200 text-center">ยกเลิก</button>
                                <button onclick="state.modal.onConfirm(); closeModal();" class="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg border-b-4 border-indigo-900 text-center">ตกลง</button>
                            ` : `
                                <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg text-center">เข้าใจแล้ว</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
